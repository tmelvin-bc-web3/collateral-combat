# Milestone v2.0: Battles System

**Status:** SHIPPED 2026-01-24
**Phases:** 10-14
**Total Plans:** 27

## Overview

Build the UFC of Crypto Trading — live 1v1 leveraged battles with spectator betting, social features, and tournament modes.

**Approach:** Audit existing code first, improve/extend where possible, only build from scratch if nothing exists.

## Phases

### Phase 10: Battle Core

**Goal**: Users can find opponents, execute leveraged trades, and receive instant payouts
**Depends on**: Phase 9 (v1.1 complete - clean, audited codebase)
**Requirements**: MATCH-01 through MATCH-05, EXEC-01 through EXEC-06, SETTLE-01 through SETTLE-04
**Plans**: 7 plans

Plans:
- [x] 10-01: ELO rating system for skill-based matchmaking
- [x] 10-02: Open challenges listing and direct wallet challenges
- [x] 10-03: Battle history database and tie handling
- [x] 10-04: Instant battle loss on total liquidation
- [x] 10-05: Tug-of-war PnL visualization
- [x] 10-06: Liquidation distance indicator
- [x] 10-07: Challenge board UI

**Key Decisions:**
- ELO K-factors: K=32 new (<30 battles), K=16 established
- Protected tier threshold: 10 battles for matchmaking isolation
- ELO tiers: bronze<1000, silver<1500, gold<2000, platinum<2500, diamond>=2500
- Tie threshold < 0.01% PnL difference
- Battle history in separate SQLite database

---

### Phase 11: Spectator Experience

**Goal**: Spectators can watch live battles and bet on outcomes with instant payouts
**Depends on**: Phase 10 (battles must exist to spectate)
**Requirements**: VIEW-01 through VIEW-05, BET-01 through BET-06
**Plans**: 4 plans

Plans:
- [x] 11-01: Fighter position cards with liquidation indicators
- [x] 11-02: Spectator tug-of-war PnL bar
- [x] 11-03: Mobile-responsive layout with collapsible chart
- [x] 11-04: Quick bet strip, auto-accept odds, pool visualization

**Key Decisions:**
- Fighter 1/Fighter 2 labels for spectator neutrality
- Spectator PnL bar uses same rope physics as participant view
- Chart collapsed by default on mobile, always visible on desktop
- 5% threshold for auto-accept odds

---

### Phase 12: Social & Engagement

**Goal**: Users can engage with battles through chat and share results for virality
**Depends on**: Phase 11 (spectator features provide engagement context)
**Requirements**: CHAT-01 through CHAT-05, SHARE-01, SHARE-02, SHARE-04
**Plans**: 5 plans

Plans:
- [x] 12-01: Chat emoji reactions and wallet-gating
- [x] 12-02: Battle chat UI component with reactions
- [x] 12-03: Server-side battle result graphics
- [x] 12-04: Twitter Card integration with og:image
- [x] 12-05: Fighter profile share cards

**Key Decisions:**
- Wallet-gating: Users must have PDA balance > 0 to chat or react
- 8 allowed emojis for reactions
- Rate limits: 1 message per 3 seconds, 1 reaction per second
- Satori + Sharp for server-side image generation

**Note:** SHARE-03 (battle clips/highlights) deferred to future phase per research recommendation.

---

### Phase 13: Fighter Identity

**Goal**: Fighters have rich profiles that showcase their trading reputation
**Depends on**: Phase 10 (battles generate stats), Phase 12 (share cards reference profiles)
**Requirements**: PROF-01 through PROF-08
**Plans**: 5 plans

Plans:
- [x] 13-01: Backend fighter stats service and API endpoints
- [x] 13-02: EloTierBadge and RecentFormIndicator components
- [x] 13-03: Extended profile page with battle stats
- [x] 13-04: Profile comparison view
- [x] 13-05: Gap closure: Trading style and favorite assets display

**Key Decisions:**
- Trading style derived from battle outcomes (aggression, leverage estimation)
- Default favorite assets SOL/ETH/BTC for new fighters
- Tier colors match opengraph-image.tsx for visual consistency
- Violet-500 for Trading Style, Amber-500 for Favorite Assets

---

### Phase 14: Events & Competitions

**Goal**: Fighters can participate in scheduled events and tournaments
**Depends on**: Phase 13 (profiles needed for tournament display), Phase 10 (battle system for tournament rounds)
**Requirements**: EVENT-01 through EVENT-05, TOUR-01 through TOUR-06
**Plans**: 6 plans

Plans:
- [x] 14-01: Event database and manager service
- [x] 14-02: Events calendar and countdown UI
- [x] 14-03: Event notifications
- [x] 14-04: Tournament database and manager
- [x] 14-05: Tournament bracket visualization
- [x] 14-06: Tournament leaderboard

**Key Decisions:**
- Registration opens 24h before event, closes 30min before start
- Separate tournaments.db SQLite file for tournament isolation
- Standard bracket seeding (1v8, 4v5, 3v6, 2v7) for 8-player tournaments
- @g-loot/react-tournament-brackets for bracket visualization

---

## Milestone Summary

**Key Decisions:**
- ELO-based matchmaking with 5 tiers (bronze → diamond)
- Tug-of-war visualization for real-time PnL comparison
- Wallet-gating for chat access (prevents spam)
- Satori+Sharp for server-side image generation (no Canvas/Puppeteer)
- Single elimination tournaments with standard bracket seeding

**Issues Resolved:**
- Phase 13 gaps (PROF-05, PROF-06) closed by plan 13-05
- All 54 requirements mapped and 53 satisfied

**Issues Deferred:**
- SHARE-03 (battle clips/highlights) deferred to v2.1

**Technical Debt Incurred:**
- Phase 14 socket events cast as 'any' (types not yet updated)
- Placeholder favorite assets data for new fighters

---

*For current project status, see .planning/ROADMAP.md*
*Archived: 2026-01-24 as part of v2.0 milestone completion*
