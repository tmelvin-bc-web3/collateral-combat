---
phase: 07-backend-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/audits/BACKEND-AUDIT.md
  - backend/src/services/*.ts
  - backend/src/middleware/*.ts
  - backend/src/utils/*.ts
  - backend/src/index.ts
autonomous: true

must_haves:
  truths:
    - "All API parameters validated against strict schemas"
    - "All WebSocket events validated against strict schemas"
    - "Wallet signature verification exists on all sensitive operations"
    - "Session key isolation enforced (session cannot withdraw)"
    - "Replay attack prevention working correctly"
  artifacts:
    - path: ".planning/audits/BACKEND-AUDIT.md"
      provides: "Input validation and auth/session audit findings"
      contains: "## SEC-01: Input Validation"
    - path: ".planning/audits/BACKEND-AUDIT.md"
      contains: "## SEC-02: Auth/Session"
  key_links:
    - from: "backend/src/index.ts"
      to: "backend/src/middleware/auth.ts"
      via: "Socket authentication middleware"
      pattern: "verifyWalletSignature|signatureVerification"
    - from: "backend/src/middleware/auth.ts"
      to: "backend/src/utils/replayCache.ts"
      via: "Replay attack prevention"
      pattern: "replayCache"
---

<objective>
Audit backend input validation (SEC-01) and auth/session security (SEC-02)

Purpose: Verify all API and WebSocket inputs are validated, wallet signatures verified on sensitive operations, and session key isolation enforced per Phase 6 contract invariants.

Output: BACKEND-AUDIT.md with SEC-01 and SEC-02 sections documenting all findings and remediations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-backend-security/07-RESEARCH.md
@.planning/phases/07-backend-security/07-CONTEXT.md
@.planning/phases/06-smart-contract-audit/06-01-SUMMARY.md
@.planning/audits/CONTRACT-AUDIT.md

# Key files to audit
@backend/src/index.ts
@backend/src/middleware/auth.ts
@backend/src/middleware/rateLimiter.ts
@backend/src/middleware/socketRateLimiter.ts
@backend/src/utils/signatureVerification.ts
@backend/src/utils/replayCache.ts
@backend/src/utils/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit Input Validation (SEC-01)</name>
  <files>
    - .planning/audits/BACKEND-AUDIT.md
    - backend/src/index.ts
    - backend/src/services/*.ts
  </files>
  <action>
Audit ALL API endpoints and WebSocket events for input validation gaps.

**Step 1: Create audit report structure**
Create `.planning/audits/BACKEND-AUDIT.md` with executive summary table and SEC-01 section.

**Step 2: Catalog all endpoints and events**
Map complete attack surface:
- REST API endpoints in index.ts (GET/POST/PUT/DELETE)
- WebSocket events in index.ts (socket.on handlers)
- Identify which accept user input

**Step 3: Check validation for each input type**
Per RESEARCH.md validation requirements:
- `walletAddress`: Must validate base58 format, 32-44 chars, regex `^[1-9A-HJ-NP-Za-km-z]{32,44}$`
- `amount` (lamports): Integer, >= MIN_BET (10,000,000), <= MAX_BET
- `amount` (SOL): Number >= 0.01, <= 100, max 9 decimals
- `side`: Enum ('long'/'short' or 'token_a'/'token_b')
- `roundId`/`battleId`/`gameId`: Positive integer or valid UUID
- `asset`/`token`: Must be in whitelist

**Step 4: Document findings**
For each finding record:
- Severity (CRITICAL/HIGH/MEDIUM/LOW)
- Affected code (file:line)
- Description of gap
- Exploit scenario (if applicable)
- Remediation (specific code change or "add Zod schema")

**Step 5: Fix as you go**
For each finding:
- If fix is straightforward (add validation), fix immediately
- If fix requires significant refactor, document as "deferred to Phase 8"
- Update status column in executive summary

**Priority order (by risk):**
1. balanceService.ts - handles real money
2. predictionServiceOnChain.ts - active game mode
3. tokenWarsManager.ts, ldsManager.ts - WIP but balance handling
4. battleManager.ts, spectatorService.ts - battle/spectator logic
5. draftTournamentManager.ts - tournament logic
6. Other services (admin, chat, progression, etc.)

**What to look for:**
- Missing validation entirely (trusting client input)
- Weak validation (checking type but not bounds)
- Wallet validation via try/catch instead of explicit check
- WebSocket events without any validation (common gap)
- Trusting client-provided wallet instead of authenticated session
  </action>
  <verify>
grep -r "socket.on\|app.get\|app.post" backend/src/index.ts | wc -l  # Count endpoints
grep -rn "walletAddress\|amount\|side" backend/src/services/*.ts | head -20  # Sample inputs
cat .planning/audits/BACKEND-AUDIT.md | grep -A5 "SEC-01"  # Verify section exists
  </verify>
  <done>
SEC-01 section complete in BACKEND-AUDIT.md with:
- Executive summary table with all input validation findings
- Each finding has: severity, affected code, description, exploit scenario, remediation, status (FIXED/DEFERRED)
- All straightforward fixes applied
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit Auth/Session Security (SEC-02)</name>
  <files>
    - .planning/audits/BACKEND-AUDIT.md
    - backend/src/middleware/auth.ts
    - backend/src/utils/signatureVerification.ts
    - backend/src/utils/replayCache.ts
    - backend/src/index.ts
    - backend/src/services/*.ts
  </files>
  <action>
Audit authentication and session security across all backend code.

**Step 1: Audit signature verification utility**
Read `backend/src/utils/signatureVerification.ts`:
- Verify it uses nacl.sign.detached.verify correctly
- Check timestamp freshness window (should be 5 min per RESEARCH.md)
- Verify replay cache integration
- Check message format consistency

**Step 2: Audit replay attack prevention**
Read `backend/src/utils/replayCache.ts`:
- Check if using Redis (per v1.0 decision) or in-memory
- If in-memory, flag as finding (doesn't survive restarts)
- Verify TTL is appropriate
- Check atomicity guarantees

**Step 3: Audit socket authentication pattern**
Examine `backend/src/index.ts` socket handlers:
- How is wallet address associated with socket?
- Is signature verified on connection or per-action?
- Are sensitive operations using authenticated wallet from session (not request body)?
- Does `getAuthenticatedWallet(socket, wallet)` pattern exist and is it used consistently?

**Step 4: Audit sensitive operations requiring auth**
Catalog which operations MUST require wallet signature:
- Placing bets (prediction, spectator, battle entry, LDS entry, token wars)
- Withdrawing funds
- Creating/revoking sessions
- Updating user settings
- Accessing user-specific data

For each, verify:
- Signature is required
- Signature is verified cryptographically
- Replay protection applied
- Authenticated wallet used (not client-provided)

**Step 5: Verify session key isolation**
Per Phase 6 INV-15, session keys CANNOT withdraw or transfer authority.
Verify backend enforces same isolation:
- Withdraw endpoints require wallet signature, not session
- Authority operations require wallet signature, not session

**Step 6: Document findings**
Add SEC-02 section to BACKEND-AUDIT.md with:
- Auth infrastructure assessment (signature verification, replay cache)
- Operation-by-operation auth audit
- Session isolation verification
- All findings with severity, code location, exploit, remediation

**Step 7: Fix as you go**
- Fix gaps in auth enforcement immediately
- Update replayCache if in-memory (flag for Redis migration if complex)
- Add missing signature verification calls
  </action>
  <verify>
grep -rn "verifyWalletSignature\|signatureVerification" backend/src/ | wc -l  # Count usages
grep -rn "replayCache" backend/src/ | wc -l  # Check replay cache usage
cat .planning/audits/BACKEND-AUDIT.md | grep -A5 "SEC-02"  # Verify section exists
  </verify>
  <done>
SEC-02 section complete in BACKEND-AUDIT.md with:
- Auth infrastructure assessment (signature verification, replay cache status)
- Audit of each sensitive operation for proper authentication
- Session key isolation verification per Phase 6 INV-15
- All findings with severity, code location, exploit scenario, remediation, status
- All straightforward fixes applied
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **BACKEND-AUDIT.md exists and is comprehensive:**
   - `cat .planning/audits/BACKEND-AUDIT.md | head -100` shows executive summary
   - SEC-01 and SEC-02 sections present with findings

2. **Input validation coverage:**
   - Count WebSocket events with validation vs without
   - Spot-check key services for validation patterns

3. **Auth coverage:**
   - Signature verification utility verified correct
   - Replay cache status documented
   - Session isolation confirmed

4. **Fixes applied:**
   - `git diff --stat` shows modified files
   - Executive summary shows FIXED status for straightforward issues
</verification>

<success_criteria>
1. BACKEND-AUDIT.md exists with executive summary table listing all SEC-01/SEC-02 findings
2. Every API endpoint and WebSocket event cataloged with validation status
3. Signature verification, replay cache, and session isolation audited and documented
4. All straightforward fixes applied (validation schemas added, auth checks added)
5. Complex fixes documented as DEFERRED with clear scope for Phase 8
6. No CRITICAL findings left unfixed (must fix immediately)
</success_criteria>

<output>
After completion, create `.planning/phases/07-backend-security/07-01-SUMMARY.md` following the summary template.

Include:
- All findings count by severity
- Key vulnerabilities discovered
- Fixes applied
- Deferred items (if any)
- Duration and completion timestamp
</output>
