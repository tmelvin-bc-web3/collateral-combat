---
phase: 07-backend-security
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - .planning/audits/BACKEND-AUDIT.md
  - backend/src/services/balanceService.ts
  - backend/src/services/predictionServiceOnChain.ts
  - backend/src/services/predictionService.ts
  - backend/src/services/battleManager.ts
  - backend/src/services/tokenWarsManager.ts
  - backend/src/services/ldsManager.ts
  - backend/src/services/spectatorService.ts
  - backend/src/services/draftTournamentManager.ts
autonomous: true

must_haves:
  truths:
    - "No TOCTOU race conditions in balance checking"
    - "All services use verifyAndLockBalance pattern for wagers"
    - "No deprecated hasSufficientBalance() calls remain"
    - "Error handling does not expose sensitive data"
    - "Partial failures handled consistently"
  artifacts:
    - path: ".planning/audits/BACKEND-AUDIT.md"
      provides: "Complete backend security audit"
      contains: "## SEC-03: Race Conditions"
    - path: ".planning/audits/BACKEND-AUDIT.md"
      contains: "## SEC-04: Error Handling"
  key_links:
    - from: "backend/src/services/*.ts"
      to: "backend/src/services/balanceService.ts"
      via: "verifyAndLockBalance pattern"
      pattern: "verifyAndLockBalance|transferToGlobalVault"
    - from: "backend/src/services/*.ts"
      to: "backend/src/utils/errors.ts"
      via: "Error type usage"
      pattern: "AppError|ValidationError"
---

<objective>
Audit backend race conditions (SEC-03) and error handling (SEC-04), fix all deprecated hasSufficientBalance usages

Purpose: Eliminate TOCTOU race conditions by migrating all services to verifyAndLockBalance pattern. Verify error handling doesn't expose sensitive data and partial failures are handled consistently.

Output: Complete BACKEND-AUDIT.md with SEC-03 and SEC-04 sections, all hasSufficientBalance usages fixed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-backend-security/07-RESEARCH.md
@.planning/phases/07-backend-security/07-CONTEXT.md
@.planning/audits/CONTRACT-AUDIT.md

# Plan 01 summary for context on prior findings
@.planning/phases/07-backend-security/07-01-SUMMARY.md

# Critical files with known hasSufficientBalance usage
@backend/src/services/balanceService.ts
@backend/src/services/predictionServiceOnChain.ts
@backend/src/services/predictionService.ts
@backend/src/services/battleManager.ts
@backend/src/services/tokenWarsManager.ts
@backend/src/services/ldsManager.ts
@backend/src/services/spectatorService.ts
@backend/src/services/draftTournamentManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and Fix Race Conditions (SEC-03)</name>
  <files>
    - .planning/audits/BACKEND-AUDIT.md
    - backend/src/services/balanceService.ts
    - backend/src/services/predictionServiceOnChain.ts
    - backend/src/services/predictionService.ts
    - backend/src/services/battleManager.ts
    - backend/src/services/tokenWarsManager.ts
    - backend/src/services/ldsManager.ts
    - backend/src/services/spectatorService.ts
    - backend/src/services/draftTournamentManager.ts
  </files>
  <action>
Find and fix ALL TOCTOU race conditions, especially deprecated hasSufficientBalance usage.

**Step 1: Understand correct pattern**
Read `backend/src/services/balanceService.ts` to understand:
- `verifyAndLockBalance()` - atomic verify + lock pattern
- `transferToGlobalVault()` - on-chain fund locking
- `debitPending()`, `confirmDebit()`, `cancelDebit()` - pending transaction tracking

Document the correct pattern flow:
1. debitPending (record intent)
2. transferToGlobalVault (on-chain lock)
3. confirmDebit (if success) or cancelDebit (if failure)

**Step 2: Find all hasSufficientBalance usages**
Per RESEARCH.md, known locations:
- predictionService.ts:348
- draftTournamentManager.ts:205
- battleManager.ts:159, 1003-1004
- tokenWarsManager.ts:802
- spectatorService.ts:227
- ldsManager.ts:1020
- predictionServiceOnChain.ts:732

Search for additional usages:
```bash
grep -rn "hasSufficientBalance\|getOnChainBalance\|balance.*>=" backend/src/services/
```

**Step 3: Fix each usage**
For each hasSufficientBalance call, migrate to verifyAndLockBalance pattern:

BEFORE (VULNERABLE):
```typescript
const hasSufficient = await balanceService.hasSufficientBalance(wallet, amount);
if (!hasSufficient) throw new Error('Insufficient balance');
// ... place bet (TOCTOU window here!)
```

AFTER (SECURE):
```typescript
const { pendingId, txSignature } = await balanceService.verifyAndLockBalance(
  wallet, amount, 'gameMode', gameId
);
// Funds now locked on-chain, can't be withdrawn
// ... record bet in backend
```

**Step 4: Handle services appropriately**

For each service, understand the betting/entry flow:
- **predictionServiceOnChain.ts**: Oracle betting - critical, fix immediately
- **predictionService.ts**: Legacy prediction - may be deprecated, document if so
- **battleManager.ts**: Battle entry fees - critical, fix immediately
- **tokenWarsManager.ts**: Token Wars betting - WIP but fix now
- **ldsManager.ts**: LDS entry - WIP but fix now
- **spectatorService.ts**: Spectator wagering - critical, fix immediately
- **draftTournamentManager.ts**: Draft entry - fix immediately

**Step 5: Audit concurrent request handling**
Beyond hasSufficientBalance, look for:
- Multiple bets placed simultaneously (same wallet, same round)
- Concurrent position opens in battles
- Double-entry prevention in tournaments
- Check for mutex/lock patterns or document absence

**Step 6: Document findings**
Add SEC-03 section to BACKEND-AUDIT.md:
- List all TOCTOU patterns found
- Document each fix with before/after code
- Identify any patterns that couldn't be fixed and why
- Recommendations for additional hardening
  </action>
  <verify>
# Verify no hasSufficientBalance calls remain
grep -rn "hasSufficientBalance" backend/src/services/ | wc -l  # Should be 0 or only in deprecated code

# Verify verifyAndLockBalance is being used
grep -rn "verifyAndLockBalance" backend/src/services/ | wc -l  # Should be 7+ (one per service)

# Check SEC-03 section exists
cat .planning/audits/BACKEND-AUDIT.md | grep -A5 "SEC-03"
  </verify>
  <done>
SEC-03 section complete in BACKEND-AUDIT.md with:
- All 7+ hasSufficientBalance usages migrated to verifyAndLockBalance
- Each migration documented with before/after code
- Concurrent request handling audited
- All TOCTOU vulnerabilities fixed or documented with mitigation plan
- Executive summary updated with race condition findings
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit Error Handling (SEC-04)</name>
  <files>
    - .planning/audits/BACKEND-AUDIT.md
    - backend/src/utils/errors.ts
    - backend/src/index.ts
    - backend/src/services/*.ts
  </files>
  <action>
Audit error handling across backend for security issues.

**Step 1: Understand error infrastructure**
Read `backend/src/utils/errors.ts`:
- What error classes are defined?
- Are there standard error codes?
- Is there a sanitization pattern?

**Step 2: Audit error responses for sensitive data exposure**
Search for patterns that expose internals:

```bash
# Direct error.message in responses
grep -rn "error.message\|err.message" backend/src/ --include="*.ts"

# Stack trace exposure
grep -rn "error.stack\|err.stack" backend/src/ --include="*.ts"

# SQL/database error exposure
grep -rn "SQLITE\|query.*error" backend/src/ --include="*.ts"
```

For each found:
- Determine if it reaches client response
- If so, flag as finding (MEDIUM severity typically)
- Document fix: use error codes, not messages

**Step 3: Audit WebSocket error emissions**
Search index.ts for socket.emit('error', ...) patterns:
- What gets emitted?
- Is it sanitized?
- Could it expose internal paths, SQL errors, etc.?

**Step 4: Audit partial failure handling**
For multi-step operations (lock funds -> record bet -> update pool), verify:
- What happens if step 2 fails after step 1 succeeds?
- Is there rollback/compensation?
- Is state consistent after failure?

Focus on:
- balanceService.ts verifyAndLockBalance flow
- predictionServiceOnChain.ts place bet flow
- battleManager.ts battle entry flow
- spectatorService.ts wager flow

Document any inconsistent states that can occur.

**Step 5: Verify error type usage**
Check if services use custom error types from errors.ts:
- AppError, ValidationError, AuthError, etc.
- Or are they using raw Error() with messages?

If not using custom types, this is a code quality finding (LOW severity).

**Step 6: Document findings**
Add SEC-04 section to BACKEND-AUDIT.md:
- Error exposure findings (where raw errors reach client)
- Partial failure analysis (which flows have gaps)
- Recommendations for error handling improvements
- All fixes applied

**Step 7: Fix critical error exposures**
- Replace raw error.message with generic messages + error codes
- Ensure stack traces never reach client
- Add try/catch around dangerous operations if missing
  </action>
  <verify>
# Check for remaining direct error.message exposures to clients
grep -rn "res.json.*error.message\|emit.*error.message" backend/src/ | wc -l  # Should be 0

# Verify SEC-04 section exists
cat .planning/audits/BACKEND-AUDIT.md | grep -A5 "SEC-04"

# Check error types are being used
grep -rn "new AppError\|new ValidationError" backend/src/ | wc -l
  </verify>
  <done>
SEC-04 section complete in BACKEND-AUDIT.md with:
- All error message exposures cataloged and critical ones fixed
- Partial failure analysis for each major flow
- Recommendations for error handling improvements
- Executive summary updated with error handling findings
  </done>
</task>

<task type="auto">
  <name>Task 3: Finalize Audit Report</name>
  <files>
    - .planning/audits/BACKEND-AUDIT.md
  </files>
  <action>
Complete the BACKEND-AUDIT.md report with executive summary and recommendations.

**Step 1: Update executive summary table**
Ensure table at top of document includes ALL findings from SEC-01 through SEC-04:

| ID | Severity | Category | Finding | Status | File:Line |
|----|----------|----------|---------|--------|-----------|
| SEC-01-001 | MEDIUM | Input Validation | Missing validation on X | FIXED | file.ts:123 |
| ... | ... | ... | ... | ... | ... |

Sort by severity (CRITICAL first, then HIGH, MEDIUM, LOW).

**Step 2: Add recommendations section**
After all SEC sections, add:
- Summary of security posture
- Priority recommendations for Phase 8 (code quality phase)
- Any architectural recommendations
- Suggestions for ongoing security practices

**Step 3: Add invariant compliance section**
Document backend compliance with Phase 6 contract invariants:

| Invariant | Backend Compliance | Verified |
|-----------|-------------------|----------|
| INV-04 (fund locking) | Uses verifyAndLockBalance | YES |
| INV-05 (state before transfer) | Follows pattern | YES |
| INV-15 (session isolation) | Enforced | YES |

**Step 4: Final verification checklist**
Add to report:
- [ ] All API endpoints validated
- [ ] All WebSocket events validated
- [ ] Signature verification on sensitive ops
- [ ] No hasSufficientBalance TOCTOU patterns
- [ ] Error messages sanitized
- [ ] Partial failures handled

**Step 5: Git commit the audit report**
Commit the final BACKEND-AUDIT.md separately from code fixes:
```bash
git add .planning/audits/BACKEND-AUDIT.md
git commit -m "docs(07): complete backend security audit report

SEC-01: Input validation audit
SEC-02: Auth/session security audit
SEC-03: Race condition audit and fixes
SEC-04: Error handling audit

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
  </action>
  <verify>
# Verify report is complete
cat .planning/audits/BACKEND-AUDIT.md | wc -l  # Should be substantial (500+ lines)

# Verify all sections exist
grep -c "^## SEC-0" .planning/audits/BACKEND-AUDIT.md  # Should be 4

# Verify executive summary has entries
grep -A20 "Executive Summary" .planning/audits/BACKEND-AUDIT.md | grep -c "SEC-"  # Should be many

# Verify committed
git log --oneline -1 | grep "backend security audit"
  </verify>
  <done>
BACKEND-AUDIT.md is complete with:
- Executive summary table listing ALL findings by severity
- SEC-01 through SEC-04 sections fully documented
- Recommendations section for Phase 8
- Contract invariant compliance verification
- Committed to git
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Race conditions eliminated:**
   ```bash
   # No hasSufficientBalance calls (except deprecated/commented)
   grep -rn "hasSufficientBalance" backend/src/services/ | grep -v "deprecated\|//"
   ```

2. **Error handling secured:**
   ```bash
   # No direct error.message to client responses
   grep -rn "json.*error.message" backend/src/ | wc -l  # Should be 0
   ```

3. **Audit report complete:**
   ```bash
   # All 4 sections present
   grep "^## SEC-0" .planning/audits/BACKEND-AUDIT.md
   ```

4. **Code changes committed:**
   ```bash
   git log --oneline -5  # Should show audit-related commits
   ```
</verification>

<success_criteria>
1. All 7+ hasSufficientBalance usages migrated to verifyAndLockBalance pattern
2. No TOCTOU race conditions remain in balance checking
3. No sensitive error data exposed to clients (stack traces, SQL errors, internal paths)
4. Partial failure handling documented for all major flows
5. BACKEND-AUDIT.md complete with SEC-01 through SEC-04
6. Executive summary shows all findings with severity and status
7. Contract invariant compliance verified (INV-04, INV-05, INV-15)
8. All code changes and audit report committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/07-backend-security/07-02-SUMMARY.md` following the summary template.

Include:
- Total findings by severity (CRITICAL: X, HIGH: X, MEDIUM: X, LOW: X)
- All hasSufficientBalance migrations documented
- Key error handling fixes
- Any deferred items for Phase 8
- Duration and completion timestamp
</output>
