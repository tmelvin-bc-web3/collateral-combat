---
phase: 17-onboarding
plan: 03
type: execute
wave: 2
depends_on: ["17-02"]
files_modified:
  - web/src/contexts/ProfileContext.tsx
  - web/src/components/ProfileSetup.tsx
  - web/src/components/ProfileSetupWrapper.tsx
autonomous: true

must_haves:
  truths:
    - "Profile setup prompt appears after first bet, not on wallet connect"
    - "User can skip profile setup and appear as truncated wallet address"
    - "Username validation enforces 3-20 characters and uniqueness"
    - "Profile setup appears after celebration dismisses"
  artifacts:
    - path: "web/src/contexts/ProfileContext.tsx"
      provides: "Modified needsSetup logic that requires hasPlacedFirstBet"
      contains: "hasPlacedFirstBet"
  key_links:
    - from: "web/src/contexts/ProfileContext.tsx"
      to: "FirstBetContext"
      via: "useFirstBetContext() for hasPlacedFirstBet"
      pattern: "useFirstBetContext"
    - from: "web/src/components/ProfileSetupWrapper.tsx"
      to: "ProfileContext.needsSetup"
      via: "conditional rendering based on needsSetup"
      pattern: "needsSetup"
---

<objective>
Modify profile setup to trigger after first bet instead of wallet connect

Purpose: Let users bet immediately after connecting, then prompt for profile personalization after they've experienced the product
Output: Modified ProfileContext with first-bet gating, updated ProfileSetup messaging, proper timing coordination
</objective>

<execution_context>
@/Users/taylermelvin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylermelvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-onboarding/17-CONTEXT.md
@.planning/phases/17-onboarding/17-RESEARCH.md
@.planning/phases/17-onboarding/17-02-SUMMARY.md
@web/src/contexts/ProfileContext.tsx
@web/src/components/ProfileSetup.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify ProfileContext to require first bet before setup prompt</name>
  <files>
    web/src/contexts/ProfileContext.tsx
  </files>
  <action>
Update ProfileContext.tsx to gate profile setup on first bet:

1. Import useFirstBetContext from '@/contexts/FirstBetContext'
2. In ProfileProvider, get { hasPlacedFirstBet, showCelebration } from useFirstBetContext()

3. Modify the needsSetup calculation (around line 73-79):
   CURRENT:
   ```typescript
   const needsSetup = !!(
     walletAddress &&
     !isLoading &&
     ownProfile &&
     !hasCustomProfile &&
     !setupCompleted
   );
   ```

   NEW:
   ```typescript
   const needsSetup = !!(
     walletAddress &&
     !isLoading &&
     ownProfile &&
     !hasCustomProfile &&
     !setupCompleted &&
     hasPlacedFirstBet &&   // Only prompt after first bet
     !showCelebration       // Wait for celebration to finish
   );
   ```

4. This ensures:
   - Profile setup ONLY appears after user has placed their first bet
   - Profile setup waits for confetti celebration to dismiss
   - Existing skip/complete logic still works

5. Export hasPlacedFirstBet in context value for components that need it
  </action>
  <verify>
Run `cd /Users/taylermelvin/Desktop/sol-battles/web && pnpm typecheck` passes.
  </verify>
  <done>
ProfileContext.needsSetup now requires hasPlacedFirstBet=true and showCelebration=false before prompting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ProfileSetup messaging for post-first-bet context</name>
  <files>
    web/src/components/ProfileSetup.tsx
  </files>
  <action>
Update ProfileSetup.tsx messaging to fit post-bet context:

1. Change the header text (line 154):
   FROM: "Welcome to Collateral Combat"
   TO: "Nice bet! Create your fighter identity"

2. Change the subtitle (line 155):
   FROM: "Set up your profile to get started"
   TO: "Stand out in the arena with a name and avatar"

3. Update username label hint:
   FROM: optional tag
   TO: Keep optional but add context: "Other fighters will see this"

4. Keep all existing functionality:
   - Username validation (3-20 chars, alphanumeric + underscore)
   - Uniqueness check via API
   - PFP selection from presets
   - Skip option
   - Save with auth check

5. From CONTEXT.md requirements:
   - Required fields: name + avatar selection (both technically optional per existing code)
   - Skip allowed â€” shown as truncated wallet address if skipped
   - Name validation: uniqueness enforced
   - Name format: 3-20 characters, basic validation (already implemented)
  </action>
  <verify>
Run `cd /Users/taylermelvin/Desktop/sol-battles/web && pnpm typecheck` passes.
  </verify>
  <done>
ProfileSetup displays post-bet celebration context messaging, encourages fighter identity creation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify ProfileSetupWrapper timing integration</name>
  <files>
    web/src/components/ProfileSetupWrapper.tsx
  </files>
  <action>
Verify ProfileSetupWrapper correctly uses the updated needsSetup logic:

1. Read the existing ProfileSetupWrapper component
2. Confirm it uses useProfileContext().needsSetup for conditional rendering
3. If ProfileSetupWrapper doesn't exist, create it or verify where ProfileSetup is rendered

Expected behavior:
- ProfileSetupWrapper renders ProfileSetup when needsSetup is true
- Since needsSetup now includes hasPlacedFirstBet && !showCelebration checks:
  - Modal appears AFTER first bet
  - Modal appears AFTER celebration animation (3 seconds)
  - Modal does NOT appear on wallet connect alone

4. If wrapper doesn't exist, check app/layout.tsx or root provider for where ProfileSetup is conditionally rendered and verify the logic path

5. Add a small delay (500ms) after celebration dismisses before showing profile setup:
   - Can be done in ProfileContext by tracking celebration dismiss time
   - Or use setTimeout in the component that renders ProfileSetup
   - This provides breathing room between celebration end and profile prompt
  </action>
  <verify>
Run `cd /Users/taylermelvin/Desktop/sol-battles/web && pnpm build` succeeds.
Manual: Connect wallet -> place first bet -> confetti plays -> confetti ends -> profile setup appears
  </verify>
  <done>
Profile setup modal appears ~500ms after first bet celebration ends, with appropriate "create your fighter identity" messaging.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes in web/
2. `pnpm build` succeeds
3. Connect wallet -> profile setup does NOT immediately appear
4. Place first bet -> confetti plays
5. After confetti ends (~3s) -> profile setup appears with new messaging
6. Skip button works, user shown as truncated wallet address
7. Save with username works, validates uniqueness
8. PFP selection from presets works
</verification>

<success_criteria>
- ONB-06: Fighter identity creation prompt appears after first bet (not on connect)
- Username validation enforces 3-20 characters with uniqueness check
- Skip allowed, shows truncated wallet address
- Profile setup doesn't interrupt the celebration moment
</success_criteria>

<output>
After completion, create `.planning/phases/17-onboarding/17-03-SUMMARY.md`
</output>
