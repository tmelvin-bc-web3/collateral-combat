---
phase: 12-social-engagement
plan: 04
type: execute
wave: 3
depends_on: ["12-02", "12-03"]
files_modified:
  - web/src/app/battle/[id]/result/page.tsx
  - web/src/components/BattleShareButtons.tsx
  - web/src/app/battle/[id]/result/opengraph-image.tsx
autonomous: true

must_haves:
  truths:
    - "User can one-click share battle result to Twitter"
    - "User can copy share link to clipboard"
    - "Twitter Card shows battle result preview image"
    - "Share URL includes user's referral code"
  artifacts:
    - path: "web/src/app/battle/[id]/result/page.tsx"
      provides: "Battle result page with share buttons"
      min_lines: 50
    - path: "web/src/components/BattleShareButtons.tsx"
      provides: "Share button component"
      exports: ["BattleShareButtons"]
    - path: "web/src/app/battle/[id]/result/opengraph-image.tsx"
      provides: "Dynamic og:image for Twitter Card"
      exports: ["default"]
  key_links:
    - from: "web/src/app/battle/[id]/result/opengraph-image.tsx"
      to: "/api/share/battle/:id/image"
      via: "ImageResponse or redirect"
      pattern: "api/share/battle"
---

<objective>
Create battle result page with Twitter share integration and dynamic Open Graph images for rich Twitter Card previews.

Purpose: Twitter Web Intents don't support image uploads directly - the og:image meta tag must point to a URL. By creating a dynamic opengraph-image route, Twitter will fetch the battle result card when users share.

Output: Battle result page with share buttons, dynamic og:image that proxies to backend image service.

**Scope Note - SHARE-03 Deferred:** Battle clip/highlight video generation (SHARE-03 from requirements) is explicitly deferred to a future phase. Per RESEARCH.md recommendation, this phase prioritizes static result cards first. Video clips require significant additional infrastructure (screen recording, video encoding, storage) that would expand scope considerably. Static images provide immediate sharing value with minimal complexity.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-social-engagement/12-02-SUMMARY.md
@.planning/phases/12-social-engagement/12-03-SUMMARY.md
@web/src/lib/shareImageGenerator.ts
@web/src/hooks/useWinShare.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BattleShareButtons component</name>
  <files>web/src/components/BattleShareButtons.tsx</files>
  <action>
Create a reusable share buttons component:

```typescript
'use client';

import { useState, useCallback } from 'react';
import { useWallet } from '@solana/wallet-adapter-react';
import { cn } from '@/lib/utils';

interface BattleShareButtonsProps {
  battleId: string;
  winAmount?: number;
  isWinner?: boolean;
  referralCode?: string;
  className?: string;
}

export function BattleShareButtons({
  battleId,
  winAmount,
  isWinner,
  referralCode,
  className,
}: BattleShareButtonsProps) {
  const [copied, setCopied] = useState(false);
  const { publicKey } = useWallet();

  // Build share URL with referral code
  const getShareUrl = useCallback(() => {
    const baseUrl = `${window.location.origin}/battle/${battleId}/result`;
    if (referralCode) {
      return `${baseUrl}?ref=${referralCode}`;
    }
    return baseUrl;
  }, [battleId, referralCode]);

  // Build Twitter share text
  const getShareText = useCallback(() => {
    if (isWinner && winAmount) {
      return `Just won ${winAmount.toFixed(2)} SOL in a @DegenDomeSolana battle!\n\nThink you can beat me?`;
    }
    return `Check out this battle on @DegenDomeSolana!`;
  }, [isWinner, winAmount]);

  const handleTwitterShare = useCallback(() => {
    const text = getShareText();
    const url = getShareUrl();
    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
    window.open(twitterUrl, '_blank', 'noopener,noreferrer,width=550,height=450');
  }, [getShareText, getShareUrl]);

  const handleCopyLink = useCallback(async () => {
    const url = getShareUrl();
    try {
      await navigator.clipboard.writeText(url);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      console.error('Failed to copy:', error);
    }
  }, [getShareUrl]);

  const handleDownloadImage = useCallback(async () => {
    // Fetch the image from backend and download
    const imageUrl = `${process.env.NEXT_PUBLIC_BACKEND_URL}/api/share/battle/${battleId}/image`;

    try {
      const response = await fetch(imageUrl);
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `degendome-battle-${battleId.slice(0, 8)}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Failed to download image:', error);
    }
  }, [battleId]);

  return (
    <div className={cn('flex gap-3', className)}>
      {/* Twitter Share */}
      <button
        onClick={handleTwitterShare}
        className="flex items-center gap-2 px-4 py-2 bg-[#1DA1F2] hover:bg-[#1a8cd8] text-white font-medium rounded-lg transition-colors"
      >
        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
        </svg>
        <span>Share on X</span>
      </button>

      {/* Copy Link */}
      <button
        onClick={handleCopyLink}
        className="flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 text-white font-medium rounded-lg transition-colors border border-white/10"
      >
        {copied ? (
          <>
            <svg className="w-5 h-5 text-[#7fba00]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
            <span>Copied!</span>
          </>
        ) : (
          <>
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
            </svg>
            <span>Copy Link</span>
          </>
        )}
      </button>

      {/* Download Image */}
      <button
        onClick={handleDownloadImage}
        className="flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 text-white font-medium rounded-lg transition-colors border border-white/10"
      >
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        <span>Download</span>
      </button>
    </div>
  );
}
```
  </action>
  <verify>
    - File exists at web/src/components/BattleShareButtons.tsx
    - `cd web && pnpm typecheck` passes
  </verify>
  <done>BattleShareButtons component with Twitter, copy link, and download buttons</done>
</task>

<task type="auto">
  <name>Task 2: Create battle result page</name>
  <files>web/src/app/battle/[id]/result/page.tsx</files>
  <action>
Create the battle result page that shows after a battle ends:

```typescript
import { Metadata } from 'next';
import { notFound } from 'next/navigation';
import { BattleShareButtons } from '@/components/BattleShareButtons';

interface PageProps {
  params: Promise<{ id: string }>;
  searchParams: Promise<{ ref?: string }>;
}

// Dynamic metadata for Twitter Cards
export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const { id } = await params;

  return {
    title: `Battle Result | DegenDome`,
    description: 'Check out this battle result on DegenDome - the UFC of crypto trading!',
    openGraph: {
      title: 'Battle Result | DegenDome',
      description: 'Check out this battle result on DegenDome!',
      type: 'website',
      images: [
        {
          url: `/battle/${id}/result/opengraph-image`,
          width: 1200,
          height: 630,
          alt: 'Battle Result',
        },
      ],
    },
    twitter: {
      card: 'summary_large_image',
      title: 'Battle Result | DegenDome',
      description: 'Check out this battle result on DegenDome!',
      images: [`/battle/${id}/result/opengraph-image`],
    },
  };
}

async function getBattleResult(id: string) {
  try {
    const res = await fetch(`${process.env.NEXT_PUBLIC_BACKEND_URL}/api/battles/${id}`, {
      next: { revalidate: 60 }, // Cache for 1 minute
    });

    if (!res.ok) return null;
    return res.json();
  } catch {
    return null;
  }
}

export default async function BattleResultPage({ params, searchParams }: PageProps) {
  const { id } = await params;
  const { ref } = await searchParams;

  const battle = await getBattleResult(id);

  if (!battle || battle.status !== 'completed') {
    notFound();
  }

  const winner = battle.players.find((p: any) => p.walletAddress === battle.winnerId);
  const loser = battle.players.find((p: any) => p.walletAddress !== battle.winnerId);

  const winAmount = battle.prizePool * 0.95; // After 5% fee

  return (
    <div className="min-h-screen bg-[#080705] text-white">
      {/* Header */}
      <header className="border-b border-white/10 bg-black/60 backdrop-blur">
        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
          <a href="/" className="flex items-baseline">
            <span className="text-[#ff5500] text-2xl font-bold">DEGEN</span>
            <span className="text-[#e8dfd4] text-2xl font-bold">DOME</span>
          </a>
          <span className="text-white/40 text-sm">BATTLE RESULT</span>
        </div>
      </header>

      {/* Main content */}
      <main className="max-w-4xl mx-auto px-4 py-12">
        {/* Result card */}
        <div className="bg-black/40 backdrop-blur border border-white/10 rounded-2xl overflow-hidden">
          {/* Winner banner */}
          <div className="bg-gradient-to-r from-[#7fba00]/20 to-[#7fba00]/5 border-b border-[#7fba00]/20 px-6 py-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-[#7fba00] text-sm font-medium">WINNER</div>
                <div className="text-white text-2xl font-bold">
                  {winner?.walletAddress?.slice(0, 4)}...{winner?.walletAddress?.slice(-4)}
                </div>
              </div>
              <div className="text-right">
                <div className="text-[#7fba00] text-3xl font-bold">
                  +{winAmount.toFixed(2)} SOL
                </div>
              </div>
            </div>
          </div>

          {/* Battle stats */}
          <div className="p-6">
            <div className="grid grid-cols-2 gap-6 mb-8">
              {/* Fighter 1 */}
              <div className={`p-4 rounded-xl ${winner?.walletAddress === battle.players[0]?.walletAddress ? 'bg-[#7fba00]/10 border border-[#7fba00]/20' : 'bg-white/5'}`}>
                <div className="text-white/40 text-xs mb-1">FIGHTER 1</div>
                <div className="text-white font-medium mb-2">
                  {battle.players[0]?.walletAddress?.slice(0, 4)}...{battle.players[0]?.walletAddress?.slice(-4)}
                </div>
                <div className={`text-2xl font-bold ${battle.players[0]?.account?.totalPnlPercent >= 0 ? 'text-[#7fba00]' : 'text-[#cc2200]'}`}>
                  {battle.players[0]?.account?.totalPnlPercent >= 0 ? '+' : ''}{battle.players[0]?.account?.totalPnlPercent?.toFixed(1)}%
                </div>
              </div>

              {/* Fighter 2 */}
              <div className={`p-4 rounded-xl ${winner?.walletAddress === battle.players[1]?.walletAddress ? 'bg-[#7fba00]/10 border border-[#7fba00]/20' : 'bg-white/5'}`}>
                <div className="text-white/40 text-xs mb-1">FIGHTER 2</div>
                <div className="text-white font-medium mb-2">
                  {battle.players[1]?.walletAddress?.slice(0, 4)}...{battle.players[1]?.walletAddress?.slice(-4)}
                </div>
                <div className={`text-2xl font-bold ${battle.players[1]?.account?.totalPnlPercent >= 0 ? 'text-[#7fba00]' : 'text-[#cc2200]'}`}>
                  {battle.players[1]?.account?.totalPnlPercent >= 0 ? '+' : ''}{battle.players[1]?.account?.totalPnlPercent?.toFixed(1)}%
                </div>
              </div>
            </div>

            {/* Stats row */}
            <div className="flex justify-center gap-8 py-4 border-t border-white/10">
              <div className="text-center">
                <div className="text-white/40 text-xs">ENTRY FEE</div>
                <div className="text-white font-medium">{battle.config?.entryFee?.toFixed(2)} SOL</div>
              </div>
              <div className="text-center">
                <div className="text-white/40 text-xs">DURATION</div>
                <div className="text-white font-medium">{Math.floor((battle.config?.duration || 300) / 60)} min</div>
              </div>
              <div className="text-center">
                <div className="text-white/40 text-xs">PRIZE POOL</div>
                <div className="text-white font-medium">{battle.prizePool?.toFixed(2)} SOL</div>
              </div>
            </div>
          </div>

          {/* Share section */}
          <div className="border-t border-white/10 p-6">
            <div className="text-center mb-4">
              <div className="text-white/60 text-sm">Share this battle</div>
            </div>
            <div className="flex justify-center">
              <BattleShareButtons
                battleId={id}
                winAmount={winAmount}
                isWinner={true}
                referralCode={ref}
              />
            </div>
          </div>
        </div>

        {/* CTA */}
        <div className="text-center mt-8">
          <a
            href="/battle"
            className="inline-block px-8 py-3 bg-[#ff5500] hover:bg-[#ff5500]/80 text-white font-bold rounded-lg transition-colors"
          >
            Start Your Own Battle
          </a>
        </div>
      </main>
    </div>
  );
}
```
  </action>
  <verify>
    - File exists at web/src/app/battle/[id]/result/page.tsx
    - `cd web && pnpm typecheck` passes
  </verify>
  <done>Battle result page shows winner, stats, and share buttons with proper metadata</done>
</task>

<task type="auto">
  <name>Task 3: Create dynamic opengraph-image route</name>
  <files>web/src/app/battle/[id]/result/opengraph-image.tsx</files>
  <action>
Create a dynamic og:image that proxies to the backend image service.

Next.js 13+ supports opengraph-image.tsx files that auto-generate og:image meta tags.
We'll proxy to the backend service that generates the actual image.

```typescript
import { ImageResponse } from 'next/og';

export const runtime = 'edge';
export const contentType = 'image/png';
export const size = { width: 1200, height: 630 };
export const alt = 'Battle Result';

export default async function OGImage({ params }: { params: { id: string } }) {
  const { id } = params;

  // Fetch the battle data to generate the image
  // Note: In production, you might want to proxy to the backend image directly
  // For now, we'll create a simple fallback image using ImageResponse

  try {
    // Try to fetch battle data
    const backendUrl = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:3001';
    const res = await fetch(`${backendUrl}/api/battles/${id}`, { next: { revalidate: 60 } });

    if (!res.ok) {
      throw new Error('Battle not found');
    }

    const battle = await res.json();

    const winner = battle.players?.find((p: any) => p.walletAddress === battle.winnerId);
    const loser = battle.players?.find((p: any) => p.walletAddress !== battle.winnerId);
    const winAmount = (battle.prizePool * 0.95).toFixed(2);

    return new ImageResponse(
      (
        <div
          style={{
            display: 'flex',
            flexDirection: 'column',
            width: '100%',
            height: '100%',
            background: 'linear-gradient(180deg, #1a1512 0%, #0a0908 100%)',
            fontFamily: 'Inter, sans-serif',
          }}
        >
          {/* Top accent */}
          <div style={{ display: 'flex', height: '4px', background: 'linear-gradient(90deg, #ff5500 0%, #ff8800 50%, #ff5500 100%)' }} />

          {/* Header */}
          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '30px 50px' }}>
            <div style={{ display: 'flex', alignItems: 'baseline' }}>
              <span style={{ color: '#ff5500', fontSize: '42px', fontWeight: 700 }}>DEGEN</span>
              <span style={{ color: '#e8dfd4', fontSize: '42px', fontWeight: 700 }}>DOME</span>
            </div>
            <span style={{ color: '#555', fontSize: '20px' }}>BATTLE RESULT</span>
          </div>

          {/* Main content */}
          <div style={{ display: 'flex', flex: 1, padding: '0 50px', gap: '40px', alignItems: 'center', justifyContent: 'center' }}>
            {/* Winner */}
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              padding: '30px 50px',
              background: 'rgba(127, 186, 0, 0.1)',
              borderRadius: '16px',
              border: '2px solid rgba(127, 186, 0, 0.3)',
            }}>
              <div style={{ background: '#7fba00', color: 'black', padding: '6px 20px', borderRadius: '20px', fontSize: '14px', fontWeight: 700, marginBottom: '16px' }}>
                WINNER
              </div>
              <span style={{ color: '#e8dfd4', fontSize: '28px', fontWeight: 600, marginBottom: '20px' }}>
                {winner?.walletAddress?.slice(0, 4)}...{winner?.walletAddress?.slice(-4)}
              </span>
              <span style={{ color: '#7fba00', fontSize: '48px', fontWeight: 700 }}>
                +{winAmount} SOL
              </span>
            </div>

            {/* VS */}
            <span style={{ color: '#ff5500', fontSize: '36px', fontWeight: 700 }}>VS</span>

            {/* Loser */}
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              padding: '30px 50px',
              background: 'rgba(255, 255, 255, 0.02)',
              borderRadius: '16px',
              border: '1px solid rgba(255, 255, 255, 0.1)',
            }}>
              <span style={{ color: '#e8dfd4', fontSize: '28px', fontWeight: 600, marginBottom: '20px' }}>
                {loser?.walletAddress?.slice(0, 4)}...{loser?.walletAddress?.slice(-4)}
              </span>
              <span style={{ color: '#cc2200', fontSize: '48px', fontWeight: 700 }}>
                {loser?.account?.totalPnlPercent?.toFixed(1)}%
              </span>
            </div>
          </div>

          {/* Footer */}
          <div style={{ display: 'flex', justifyContent: 'center', padding: '30px', borderTop: '1px solid rgba(255,255,255,0.05)' }}>
            <span style={{ color: '#444', fontSize: '18px' }}>degendome.xyz</span>
          </div>
        </div>
      ),
      {
        ...size,
      }
    );
  } catch {
    // Fallback image if battle not found
    return new ImageResponse(
      (
        <div
          style={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            width: '100%',
            height: '100%',
            background: 'linear-gradient(180deg, #1a1512 0%, #0a0908 100%)',
          }}
        >
          <div style={{ display: 'flex', alignItems: 'baseline' }}>
            <span style={{ color: '#ff5500', fontSize: '64px', fontWeight: 700 }}>DEGEN</span>
            <span style={{ color: '#e8dfd4', fontSize: '64px', fontWeight: 700 }}>DOME</span>
          </div>
          <span style={{ color: '#555', fontSize: '24px', marginTop: '20px' }}>Battle Result</span>
        </div>
      ),
      { ...size }
    );
  }
}
```
  </action>
  <verify>
    - File exists at web/src/app/battle/[id]/result/opengraph-image.tsx
    - `cd web && pnpm typecheck` passes
    - `cd web && pnpm build` succeeds
  </verify>
  <done>Dynamic og:image generates Twitter Card preview from battle data</done>
</task>

</tasks>

<verification>
1. `cd web && pnpm typecheck` passes
2. `cd web && pnpm build` succeeds
3. BattleShareButtons component renders Twitter, Copy, Download buttons
4. Battle result page fetches and displays battle data
5. opengraph-image.tsx generates dynamic preview
6. Share URL includes referral code when provided
</verification>

<success_criteria>
- Twitter share button opens intent with correct text and URL
- Copy link copies URL with referral code to clipboard
- Download button fetches image from backend and triggers download
- Battle result page shows winner, both fighters' PnL, stats
- og:image meta tag points to dynamic image route
- Twitter Card preview shows battle result graphic
</success_criteria>

<output>
After completion, create `.planning/phases/12-social-engagement/12-04-SUMMARY.md`
</output>
