---
phase: 18-polish
plan: 03
type: execute
wave: 2
depends_on: ["18-01", "18-02"]
files_modified:
  - web/src/components/animations/CountingNumber.tsx
  - web/src/components/animations/DeltaBadge.tsx
  - web/src/components/animations/UrgentTimer.tsx
  - web/src/components/animations/index.ts
  - web/src/components/watch/BattleSlide.tsx
  - web/src/components/feedback/WinModal.tsx
  - web/package.json
  - web/src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Live data (odds, positions, balance) updates within 500ms"
    - "Number changes animate smoothly from old to new value"
    - "Balance shows +/- delta badge briefly after changes"
    - "Timer turns yellow at 1 min, red at 30s, pulses at 10s"
  artifacts:
    - path: "web/src/components/animations/CountingNumber.tsx"
      provides: "Animated number display with count-up effect"
      min_lines: 40
    - path: "web/src/components/animations/DeltaBadge.tsx"
      provides: "Brief +/- change indicator badge"
      min_lines: 30
    - path: "web/src/components/animations/UrgentTimer.tsx"
      provides: "Timer with progressive urgency colors"
      min_lines: 50
    - path: "web/package.json"
      provides: "react-countup and sonner dependencies"
      contains: "react-countup"
  key_links:
    - from: "web/src/components/animations/CountingNumber.tsx"
      to: "react-countup"
      via: "CountUp component"
      pattern: "from 'react-countup'"
    - from: "web/src/components/feedback/WinModal.tsx"
      to: "CountingNumber"
      via: "animated payout display"
      pattern: "CountingNumber"
---

<objective>
Implement live data animations and performance optimizations

Purpose: Ensure sub-500ms state updates with smooth number animations and progressive timer urgency (POL-06, POL-07)
Output: CountingNumber, DeltaBadge, UrgentTimer components with react-countup and sonner integration
</objective>

<execution_context>
@/Users/taylermelvin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylermelvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-polish/18-RESEARCH.md
@.planning/phases/18-polish/18-01-SUMMARY.md

# Files to modify
@web/src/components/watch/BattleSlide.tsx
@web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create animation components</name>
  <files>
    web/package.json
    web/src/components/animations/CountingNumber.tsx
    web/src/components/animations/DeltaBadge.tsx
    web/src/components/animations/UrgentTimer.tsx
    web/src/components/animations/index.ts
  </files>
  <action>
**Install dependencies:**
```bash
cd web && pnpm add react-countup sonner
```

**Create animations directory and components:**

**CountingNumber.tsx:**
Animated number display with smooth count-up transitions:
```typescript
'use client';

import { useState, useEffect, useRef } from 'react';
import CountUp from 'react-countup';

interface CountingNumberProps {
  value: number;
  decimals?: number;
  suffix?: string;
  prefix?: string;
  duration?: number;
  className?: string;
}

export function CountingNumber({
  value,
  decimals = 2,
  suffix = '',
  prefix = '',
  duration = 0.4,
  className,
}: CountingNumberProps) {
  const [prevValue, setPrevValue] = useState(value);
  const isFirstRender = useRef(true);

  useEffect(() => {
    if (isFirstRender.current) {
      isFirstRender.current = false;
      return;
    }
    setPrevValue(value);
  }, [value]);

  return (
    <CountUp
      start={isFirstRender.current ? value : prevValue}
      end={value}
      duration={duration}
      decimals={decimals}
      prefix={prefix}
      suffix={suffix}
      preserveValue
      className={className}
    />
  );
}
```

**DeltaBadge.tsx:**
Brief +/- change indicator that fades out after 2s:
```typescript
'use client';

import { useEffect, useState } from 'react';
import { cn } from '@/lib/utils';

interface DeltaBadgeProps {
  delta: number;
  decimals?: number;
  suffix?: string;
  duration?: number;
  className?: string;
}

export function DeltaBadge({
  delta,
  decimals = 2,
  suffix = ' SOL',
  duration = 2000,
  className,
}: DeltaBadgeProps) {
  const [visible, setVisible] = useState(delta !== 0);

  useEffect(() => {
    if (delta !== 0) {
      setVisible(true);
      const timer = setTimeout(() => setVisible(false), duration);
      return () => clearTimeout(timer);
    }
  }, [delta, duration]);

  if (!visible || delta === 0) return null;

  const isPositive = delta > 0;

  return (
    <span
      className={cn(
        'text-xs font-bold animate-fadeIn',
        isPositive ? 'text-success' : 'text-danger',
        className
      )}
    >
      {isPositive ? '+' : ''}{delta.toFixed(decimals)}{suffix}
    </span>
  );
}
```

**UrgentTimer.tsx:**
Timer with progressive urgency colors per CONTEXT.md:
- Normal (>1min): default text color
- Warning (30s-1min): yellow/warning color
- Danger (<30s): red color
- Critical (<10s): red + pulse animation

```typescript
'use client';

import { useEffect, useState } from 'react';
import { cn } from '@/lib/utils';

interface UrgentTimerProps {
  endTime: number; // Unix timestamp in ms
  className?: string;
  onComplete?: () => void;
}

export function UrgentTimer({
  endTime,
  className,
  onComplete,
}: UrgentTimerProps) {
  const [secondsLeft, setSecondsLeft] = useState(0);

  useEffect(() => {
    const updateTimer = () => {
      const now = Date.now();
      const remaining = Math.max(0, Math.floor((endTime - now) / 1000));
      setSecondsLeft(remaining);

      if (remaining === 0 && onComplete) {
        onComplete();
      }
    };

    updateTimer();
    const interval = setInterval(updateTimer, 100); // 100ms for smooth countdown

    return () => clearInterval(interval);
  }, [endTime, onComplete]);

  const minutes = Math.floor(secondsLeft / 60);
  const seconds = secondsLeft % 60;

  // Progressive urgency colors
  const colorClass =
    secondsLeft > 60
      ? 'text-text-primary'      // Normal: >1 min
      : secondsLeft > 30
        ? 'text-warning'          // Warning: 30s-1min (yellow)
        : 'text-danger';          // Danger: <30s (red)

  const shouldPulse = secondsLeft <= 10 && secondsLeft > 0;

  return (
    <div
      className={cn(
        'text-2xl font-mono font-bold tabular-nums',
        colorClass,
        shouldPulse && 'animate-pulse',
        className
      )}
    >
      {minutes}:{seconds.toString().padStart(2, '0')}
    </div>
  );
}
```

**index.ts:**
```typescript
export { CountingNumber } from './CountingNumber';
export { DeltaBadge } from './DeltaBadge';
export { UrgentTimer } from './UrgentTimer';
```
  </action>
  <verify>
Dependencies installed: `grep "react-countup" web/package.json`
Build passes: `cd web && pnpm build`
  </verify>
  <done>
react-countup and sonner installed, animation components created with proper typing
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Toaster to app layout and integrate sonner</name>
  <files>
    web/src/app/layout.tsx
  </files>
  <action>
Add the Sonner Toaster component to the app layout:

1. Import Toaster from sonner at top of file:
```typescript
import { Toaster } from 'sonner';
```

2. Add Toaster inside the providers, near the end of the body:
```tsx
<body>
  {/* existing providers */}
  <Toaster
    position="top-center"
    toastOptions={{
      duration: 3000,
      style: {
        background: '#0d0b09',
        border: '1px solid rgba(255, 255, 255, 0.1)',
        color: '#e8dfd4',
      },
    }}
  />
</body>
```

Position "top-center" for mobile-friendly display.
Style matches project theme (bg-secondary, border-white/10, text-primary).
  </action>
  <verify>
Build passes: `cd web && pnpm build`
Grep: `grep "Toaster" web/src/app/layout.tsx`
  </verify>
  <done>
Sonner Toaster configured in app layout with project theme styling
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate animations into WinModal and BattleSlide</name>
  <files>
    web/src/components/feedback/WinModal.tsx
    web/src/components/watch/BattleSlide.tsx
  </files>
  <action>
**WinModal.tsx:**
Update to use CountingNumber for the payout display:

1. Import CountingNumber:
```typescript
import { CountingNumber } from '@/components/animations';
```

2. Replace static payout display with animated version:
```tsx
// Instead of: <span>{result.payout.toFixed(2)} SOL</span>
<CountingNumber
  value={result.payout - result.fees}
  decimals={2}
  prefix="+"
  suffix=" SOL"
  className="text-3xl text-success font-bold"
/>
```

**BattleSlide.tsx:**
First read the file to understand its structure. Then:

1. Import UrgentTimer:
```typescript
import { UrgentTimer } from '@/components/animations';
```

2. If there's a timer display showing battle remaining time, replace it with UrgentTimer component:
```tsx
<UrgentTimer
  endTime={battle.endTime || (Date.now() + 300000)} // 5 min default
  onComplete={() => {/* handle battle end */}}
/>
```

3. For odds display, consider using CountingNumber if odds update frequently:
```tsx
<CountingNumber
  value={odds?.player1.odds ?? 2.0}
  decimals={2}
  suffix="x"
  duration={0.3}
/>
```

Note: Only add animations where values actually change. Static values don't need CountingNumber.
  </action>
  <verify>
Build passes: `cd web && pnpm build`
Grep for imports: `grep -l "CountingNumber\|UrgentTimer" web/src/components/`
  </verify>
  <done>
WinModal shows animated payout with CountingNumber, BattleSlide uses UrgentTimer for battle countdown
  </done>
</task>

</tasks>

<verification>
1. `cd web && pnpm build` - TypeScript compiles without errors
2. `grep "react-countup" web/package.json` - dependency installed
3. `ls web/src/components/animations/` - all component files exist
4. `grep "Toaster" web/src/app/layout.tsx` - sonner configured
5. `grep "CountingNumber" web/src/components/feedback/WinModal.tsx` - animation integrated
</verification>

<success_criteria>
- react-countup and sonner dependencies installed
- CountingNumber component animates between number values in 400ms
- DeltaBadge shows +/- change indicator for 2s then fades
- UrgentTimer shows progressive urgency (yellow > red > pulse)
- Sonner Toaster configured with project theme
- WinModal payout animates with CountingNumber
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-polish/18-03-SUMMARY.md`
</output>
