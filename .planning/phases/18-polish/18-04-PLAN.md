---
phase: 18-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/components/watch/QuickBetStripV2.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "QuickBetStripV2 displays real balance from useSessionBetting hook"
    - "Balance updates immediately (optimistic) after bet placement"
    - "Balance syncs with on-chain state after bet settles"
  artifacts:
    - path: "web/src/components/watch/QuickBetStripV2.tsx"
      provides: "Real balance integration with optimistic updates"
      contains: "useSessionBetting"
      pattern: "balanceInSol"
  key_links:
    - from: "QuickBetStripV2.tsx"
      to: "useSessionBetting"
      via: "hook import and usage"
      pattern: "const.*balanceInSol.*fetchBalance.*=.*useSessionBetting"
    - from: "QuickBetStripV2.tsx success effect"
      to: "fetchBalance"
      via: "reconcile on-chain after success"
      pattern: "fetchBalance\\(\\)"
---

<objective>
Replace mock balance with real balance integration in QuickBetStripV2

Purpose: Close verification gap POL-02 - "User sees immediate balance update after bet settles (optimistic UI)"
Output: QuickBetStripV2 uses useSessionBetting for real balance instead of useState mockBalance
</objective>

<execution_context>
@/Users/taylermelvin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylermelvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-polish/18-VERIFICATION.md

# Existing hook interface (from useSessionBetting.ts)
# balanceInSol - current balance in SOL (derived from userBalance)
# fetchBalance - refresh balance from on-chain

# Reference implementation
@web/src/components/WalletBalance.tsx
@web/src/components/onboarding/PostConnectFeedback.tsx

# File to modify
@web/src/components/watch/QuickBetStripV2.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace mockBalance with useSessionBetting integration</name>
  <files>web/src/components/watch/QuickBetStripV2.tsx</files>
  <action>
    1. Add useSessionBetting import:
       ```typescript
       import { useSessionBetting } from '@/hooks/useSessionBetting';
       ```

    2. Replace the mockBalance useState (around line 77) with useSessionBetting hook:
       ```typescript
       // Get real balance from session betting hook
       const { balanceInSol, fetchBalance } = useSessionBetting();
       ```

       REMOVE the line:
       ```typescript
       const [mockBalance, setMockBalance] = useState(1.0);
       ```

    3. Update the success effect (around lines 118-165) to:
       - Use `balanceInSol` instead of `mockBalance` for balance calculations
       - Call `fetchBalance()` after bet success to reconcile with on-chain state
       - Remove `setMockBalance(newBalance)` call

       The updated effect should look like:
       ```typescript
       useEffect(() => {
         // Detect transition to 'success' state
         if (state === 'success' && prevStateRef.current !== 'success' && pendingBet) {
           // Record first bet if applicable
           if (!hasPlacedFirstBet) {
             recordFirstBet();
           }

           // Get the fighter odds for this bet
           const fighterOdds = pendingBet.fighterWallet === player1?.walletAddress
             ? player1Odds
             : player2Odds;

           // Calculate payout (demo mode: always win)
           const betAmount = pendingBet.amount;
           const grossPayout = betAmount * fighterOdds;
           const fees = grossPayout * 0.05; // 5% platform fee
           const netPayout = grossPayout - fees;

           // Calculate new balance using current on-chain balance
           const newBalance = balanceInSol - betAmount + netPayout;

           // Create bet result
           const result: BetResult = {
             won: true, // Demo: always win
             bet: betAmount,
             payout: grossPayout,
             fees: fees,
             newBalance: newBalance,
           };

           // Trigger win feedback
           triggerWin(result);

           // Refresh balance from on-chain to reconcile
           fetchBalance();
         }
         prevStateRef.current = state;
       }, [
         state,
         hasPlacedFirstBet,
         recordFirstBet,
         pendingBet,
         player1,
         player1Odds,
         player2Odds,
         balanceInSol,
         triggerWin,
         fetchBalance,
       ]);
       ```

    4. Remove mockBalance from any remaining places in the component (scan for "mockBalance").

    Note: This change ensures:
    - Real balance is displayed (shared state with WalletBalance and other components)
    - Optimistic UI: newBalance calculation happens immediately
    - On-chain reconciliation: fetchBalance() syncs after settlement
  </action>
  <verify>
    Run `pnpm build` in web/ directory - must pass with no TypeScript errors.
    Grep for "mockBalance" in QuickBetStripV2.tsx - should return 0 results.
    Grep for "useSessionBetting" in QuickBetStripV2.tsx - should return 1 result (the import).
  </verify>
  <done>
    QuickBetStripV2 uses balanceInSol from useSessionBetting instead of local mockBalance state.
    Balance updates are optimistic (immediate calculation) and reconciled via fetchBalance().
    No references to mockBalance remain in the file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify build and gap closure</name>
  <files>web/src/components/watch/QuickBetStripV2.tsx</files>
  <action>
    1. Run full build to ensure no TypeScript errors:
       ```bash
       cd web && pnpm build
       ```

    2. Verify the key link is wired by checking the file contains:
       - Import: `import { useSessionBetting }`
       - Hook call: `const { balanceInSol, fetchBalance } = useSessionBetting()`
       - Reconciliation: `fetchBalance()` called in success effect

    3. Confirm mockBalance is completely removed:
       ```bash
       grep -n "mockBalance" web/src/components/watch/QuickBetStripV2.tsx
       ```
       Should return empty (no matches).

    4. Confirm useSessionBetting is properly imported:
       ```bash
       grep -n "useSessionBetting" web/src/components/watch/QuickBetStripV2.tsx
       ```
       Should show import line.
  </action>
  <verify>
    `pnpm build` passes.
    `grep mockBalance` returns no results.
    `grep useSessionBetting` returns import line.
    `grep fetchBalance` shows call in success effect.
  </verify>
  <done>
    Build passes with real balance integration.
    Gap POL-02 is closed - balance updates use real state from useSessionBetting.
  </done>
</task>

</tasks>

<verification>
1. Build verification:
   ```bash
   cd web && pnpm build
   ```
   Must pass with no errors.

2. Key link verification:
   ```bash
   grep -n "useSessionBetting\|balanceInSol\|fetchBalance" web/src/components/watch/QuickBetStripV2.tsx
   ```
   Should show:
   - useSessionBetting import
   - balanceInSol usage
   - fetchBalance call

3. Mock removal verification:
   ```bash
   grep -n "mockBalance" web/src/components/watch/QuickBetStripV2.tsx
   ```
   Must return empty.
</verification>

<success_criteria>
- QuickBetStripV2 imports and uses useSessionBetting hook
- balanceInSol replaces mockBalance for balance display and calculations
- fetchBalance() is called after bet success to reconcile with on-chain state
- No references to mockBalance remain
- Build passes with no TypeScript errors
- Gap POL-02 is satisfied: "User sees immediate balance update after bet settles (optimistic UI)"
</success_criteria>

<output>
After completion, create `.planning/phases/18-polish/18-04-SUMMARY.md`
</output>
