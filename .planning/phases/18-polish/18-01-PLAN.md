---
phase: 18-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/components/feedback/WinModal.tsx
  - web/src/components/feedback/LossFlash.tsx
  - web/src/components/feedback/PayoutBreakdown.tsx
  - web/src/components/watch/QuickBetStripV2.tsx
  - web/src/hooks/useBetFeedback.ts
  - web/package.json
autonomous: true

must_haves:
  truths:
    - "User sees contained celebration modal on bet win (confetti + payout summary)"
    - "User sees subtle red flash on balance when bet loses (no modal)"
    - "User can tap to expand payout breakdown (bet, winnings, fees, new balance)"
    - "Balance updates immediately after bet settles (optimistic)"
  artifacts:
    - path: "web/src/components/feedback/WinModal.tsx"
      provides: "Win celebration modal with confetti trigger"
      min_lines: 80
    - path: "web/src/components/feedback/LossFlash.tsx"
      provides: "Subtle loss indicator for balance"
      min_lines: 30
    - path: "web/src/components/feedback/PayoutBreakdown.tsx"
      provides: "Expandable payout details component"
      min_lines: 60
    - path: "web/src/hooks/useBetFeedback.ts"
      provides: "Hook to trigger win/loss feedback"
      exports: ["useBetFeedback"]
  key_links:
    - from: "web/src/components/watch/QuickBetStripV2.tsx"
      to: "useBetFeedback"
      via: "hook usage on bet state transition"
      pattern: "useBetFeedback"
    - from: "web/src/components/feedback/WinModal.tsx"
      to: "useConfetti"
      via: "confetti trigger on mount"
      pattern: "triggerConfetti"
---

<objective>
Implement win/loss feedback screens and optimistic balance updates

Purpose: Provide unambiguous, satisfying feedback for betting outcomes (POL-01, POL-02, POL-03)
Output: Feedback components (WinModal, LossFlash, PayoutBreakdown) and useBetFeedback hook integrated into QuickBetStripV2
</objective>

<execution_context>
@/Users/taylermelvin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylermelvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-polish/18-RESEARCH.md

# Existing implementation
@web/src/components/Confetti.tsx
@web/src/components/watch/QuickBetStripV2.tsx
@web/src/hooks/useBetState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feedback components (WinModal, LossFlash, PayoutBreakdown)</name>
  <files>
    web/src/components/feedback/WinModal.tsx
    web/src/components/feedback/LossFlash.tsx
    web/src/components/feedback/PayoutBreakdown.tsx
    web/src/components/feedback/index.ts
  </files>
  <action>
Create the feedback components directory and files:

**WinModal.tsx:**
- Contained celebration modal (card overlay, NOT full-screen takeover per CONTEXT.md)
- Triggers confetti via useConfetti hook on mount
- Shows net result prominently: "You won +{net} SOL" in success color
- Contains PayoutBreakdown component (collapsed by default)
- Has "Continue" button to dismiss
- z-index: 50 (above QuickBetStrip z-40)
- Animation: animate-fadeIn for entrance, simple scale transition
- Props: { result: BetResult; onDismiss: () => void }
- BetResult type: { won: boolean; bet: number; payout: number; fees: number; newBalance: number }

**LossFlash.tsx:**
- Minimal loss indicator - NO modal (per CONTEXT.md: "let them move on")
- Just a component that flashes the balance text red briefly
- Uses CSS transition: text-danger class + animate-pulse for 1 second
- Props: { isActive: boolean; onComplete: () => void }
- Self-dismisses after animation completes

**PayoutBreakdown.tsx:**
- Expandable details component (per CONTEXT.md: tap to expand)
- Default state: collapsed, shows only net result
- Expanded state: shows Bet, Winnings, Fees (5%), New Balance
- Uses ChevronDown icon with rotate-180 on expand
- Tailwind classes for transitions: animate-slideDown when expanding
- Format numbers to 2 decimal places with SOL suffix

**index.ts:**
- Export all components from single entry point
  </action>
  <verify>
Files exist with correct structure:
- `ls web/src/components/feedback/`
- TypeScript compiles: `cd web && pnpm build`
  </verify>
  <done>
WinModal, LossFlash, and PayoutBreakdown components exist with proper props and styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useBetFeedback hook</name>
  <files>
    web/src/hooks/useBetFeedback.ts
  </files>
  <action>
Create a hook that manages bet outcome feedback:

**useBetFeedback hook:**
```typescript
interface BetResult {
  won: boolean;
  bet: number;
  payout: number;
  fees: number;
  newBalance: number;
}

interface UseBetFeedbackReturn {
  showWinModal: boolean;
  showLossFlash: boolean;
  result: BetResult | null;
  triggerWin: (result: BetResult) => void;
  triggerLoss: (result: BetResult) => void;
  dismissWin: () => void;
  dismissLoss: () => void;
}
```

Hook behavior:
- `triggerWin()`: Sets showWinModal true, stores result
- `triggerLoss()`: Sets showLossFlash true, stores result, auto-dismisses after 1s
- `dismissWin()`: Sets showWinModal false, clears result
- `dismissLoss()`: Sets showLossFlash false (also auto-called after 1s timeout)
- Uses useCallback for all functions
- Cleans up timeouts on unmount

Add haptic feedback (progressive enhancement):
- On win: `navigator.vibrate([100, 50, 100])` (celebration pattern)
- On loss: no vibration (don't rub it in)
- Feature detect: `if ('vibrate' in navigator)`
  </action>
  <verify>
Hook exports correctly:
- TypeScript compiles: `cd web && pnpm build`
  </verify>
  <done>
useBetFeedback hook exports triggerWin, triggerLoss, and state for rendering feedback components
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate feedback into QuickBetStripV2</name>
  <files>
    web/src/components/watch/QuickBetStripV2.tsx
  </files>
  <action>
Wire feedback components into the betting flow:

1. Import useBetFeedback hook and feedback components
2. Add useBetFeedback() call in component
3. Modify bet success handler to detect win/loss:
   - Currently uses state === 'success' to trigger first bet celebration
   - Need to add win/loss detection based on bet result
   - For now, mock the result since we don't have real settlement yet:
     - Assume bet always "wins" when state === 'success' for demo purposes
     - Calculate mock payout = bet amount * odds
     - Calculate mock fees = payout * 0.05
     - Calculate mock newBalance = currentBalance - bet + payout - fees

4. Call triggerWin() or triggerLoss() based on result when state transitions to 'success'

5. Render WinModal and LossFlash components:
```tsx
{showWinModal && result && (
  <WinModal result={result} onDismiss={dismissWin} />
)}
<LossFlash isActive={showLossFlash} onComplete={dismissLoss} />
```

Note: The win modal uses confetti internally, so remove the direct confetti trigger from first bet celebration (keep the first bet recording logic, just let WinModal handle confetti)
  </action>
  <verify>
Build passes:
- `cd web && pnpm build`
Manual test: Start dev server, place a bet, verify modal appears on success
  </verify>
  <done>
QuickBetStripV2 shows WinModal on bet success with confetti and payout breakdown
  </done>
</task>

</tasks>

<verification>
1. `cd web && pnpm build` - TypeScript compiles without errors
2. Components exist: `ls web/src/components/feedback/`
3. Hook exports: grep for "export function useBetFeedback" in hooks directory
4. Integration: grep for "useBetFeedback" in QuickBetStripV2.tsx
</verification>

<success_criteria>
- WinModal displays on bet win with confetti, net result, and expandable breakdown
- LossFlash briefly flashes balance red on loss
- PayoutBreakdown shows bet/winnings/fees/new balance when expanded
- useBetFeedback hook manages feedback state and haptics
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-polish/18-01-SUMMARY.md`
</output>
