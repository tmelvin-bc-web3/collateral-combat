---
phase: 09-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/setup-multisig.ts
  - scripts/transfer-authority-to-multisig.ts
  - docs/MULTISIG-SETUP.md
  - docs/SECURITY-AUDIT-REPORT.md
autonomous: true

must_haves:
  truths:
    - "Multi-sig authority setup documented with 2-of-3 configuration"
    - "Authority transfer scripts ready for mainnet deployment"
    - "Security audit report consolidates all v1.1 findings"
    - "Runbook exists for multi-sig operations"
  artifacts:
    - path: "scripts/setup-multisig.ts"
      provides: "Squads Protocol multi-sig creation script"
      contains: "multisig.rpc.multisigCreate"
    - path: "scripts/transfer-authority-to-multisig.ts"
      provides: "Authority transfer script"
      contains: "proposeAuthorityTransfer"
    - path: "docs/MULTISIG-SETUP.md"
      provides: "Multi-sig configuration and operation guide"
      contains: "2-of-3"
    - path: "docs/SECURITY-AUDIT-REPORT.md"
      provides: "Consolidated security audit report"
      contains: "Severity"
  key_links:
    - from: "scripts/setup-multisig.ts"
      to: "@sqds/multisig"
      via: "import"
      pattern: "@sqds/multisig"
    - from: "scripts/transfer-authority-to-multisig.ts"
      to: "programs/session_betting"
      via: "program client"
      pattern: "proposeAuthorityTransfer"
---

<objective>
Implement multi-sig authority and create security audit report

Purpose: Eliminate single-point-of-failure risk via Squads Protocol multi-sig and consolidate all v1.1 audit findings for external review (INT-02)
Output: Multi-sig setup scripts, authority transfer scripts, operational runbook, consolidated security audit report
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration/09-CONTEXT.md
@.planning/phases/09-integration/09-RESEARCH.md
@programs/session_betting/programs/session_betting/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-sig setup and authority transfer scripts</name>
  <files>
    scripts/setup-multisig.ts
    scripts/transfer-authority-to-multisig.ts
  </files>
  <action>
Create scripts/setup-multisig.ts that uses Squads Protocol v4 to create a 2-of-3 multi-sig:

```typescript
// Required packages: @sqds/multisig @solana/web3.js
import * as multisig from "@sqds/multisig";
import { Connection, Keypair, PublicKey } from "@solana/web3.js";

// Configuration
const THRESHOLD = 2;  // 2-of-3 approval required
const MEMBER_COUNT = 3;

// Script should:
// 1. Load connection from RPC_URL env var
// 2. Accept member public keys as arguments (placeholder addresses for now)
// 3. Generate create key for multi-sig PDA derivation
// 4. Call multisig.rpc.multisigCreate with:
//    - threshold: 2
//    - members: 3 members with Permissions.all()
//    - configAuthority: null (immutable - per RESEARCH.md discussion)
//    - timeLock: 0
// 5. Output multi-sig PDA address for use in authority transfer

// Example usage: npx ts-node scripts/setup-multisig.ts <member1> <member2> <member3>
```

Create scripts/transfer-authority-to-multisig.ts for authority transfer:

```typescript
// Script should:
// 1. Load current authority keypair from SESSION_BETTING_AUTHORITY_PRIVATE_KEY
// 2. Accept multi-sig PDA as argument
// 3. Call proposeAuthorityTransfer(multisigPda) on session_betting program
// 4. Output instructions for multi-sig members to approve accept_authority_transfer
//
// Two-step process (existing contract pattern):
// Step 1: Current authority calls propose_authority_transfer
// Step 2: Multi-sig members vote via Squads UI/CLI to call accept_authority_transfer
```

Include clear comments explaining:
- Why 2-of-3 (allows one key loss while maintaining security)
- Why configAuthority=null (immutable for max security, per RESEARCH.md)
- Steps to run on devnet first, then mainnet

Do NOT run the scripts - just create them. User will execute at deployment time.
  </action>
  <verify>
- scripts/setup-multisig.ts exists with Squads Protocol integration
- scripts/transfer-authority-to-multisig.ts exists with two-step transfer
- npm run typecheck passes (or tsc --noEmit scripts/*.ts)
  </verify>
  <done>
Multi-sig setup and authority transfer scripts created. Ready for deployment execution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create multi-sig operational documentation</name>
  <files>
    docs/MULTISIG-SETUP.md
  </files>
  <action>
Create docs/MULTISIG-SETUP.md with comprehensive multi-sig documentation:

**1. Configuration Rationale**
- Why Squads Protocol (formally verified, $10B+ secured, industry standard)
- Why 2-of-3 threshold (balance between security and operational flexibility)
- Why immutable configAuthority (maximum security for mainnet)

**2. Setup Instructions**
- Prerequisites (Node.js, packages, RPC access)
- Step-by-step for devnet testing
- Step-by-step for mainnet deployment
- Expected outputs and verification steps

**3. Multi-Sig Operations Runbook**
- How to propose a transaction (e.g., credit_winnings batch)
- How members approve via Squads UI (https://app.squads.so)
- How to execute after threshold reached
- Emergency procedures (e.g., member key compromise)

**4. Member Responsibilities**
- Key storage requirements (hardware wallet recommended)
- Response time expectations
- Communication channels for approval requests

**5. Deployment Checklist**
- [ ] All member keys generated (hardware wallets)
- [ ] Devnet test successful
- [ ] Authority transfer proposed
- [ ] All members approved
- [ ] Transfer accepted
- [ ] Old authority key secured/destroyed

Include warning: "Assign specific signers at deployment time. This document provides structure only."
  </action>
  <verify>
- docs/MULTISIG-SETUP.md exists with all sections
- Runbook includes operational procedures
- Deployment checklist is actionable
  </verify>
  <done>
Multi-sig operational documentation complete with setup guide, runbook, and deployment checklist.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create consolidated security audit report</name>
  <files>
    docs/SECURITY-AUDIT-REPORT.md
  </files>
  <action>
Create docs/SECURITY-AUDIT-REPORT.md consolidating all v1.1 audit findings in security audit format:

**Document Structure:**

```markdown
# Sol-Battles Security Audit Report

**Version:** 1.1
**Date:** [CURRENT_DATE]
**Auditors:** Internal review + Claude-assisted analysis
**Scope:** Smart contract, backend services, economic model

## Executive Summary
- Overall assessment: [PASS/CONDITIONAL PASS]
- Critical findings: 0 unresolved
- High findings: 0 unresolved
- Medium findings: [count] (documented as accepted risks)

## Findings Summary

| ID | Severity | Category | Status | Description |
|----|----------|----------|--------|-------------|
| SC-001 | CRITICAL | Smart Contract | RESOLVED | [if any from Phase 6] |
| BE-001 | HIGH | Backend | RESOLVED | TOCTOU race conditions (Phase 7.2) |
| ... | ... | ... | ... | ... |

## Detailed Findings

### [Finding ID]: [Title]
**Severity:** CRITICAL/HIGH/MEDIUM/LOW
**Category:** Smart Contract / Backend / Economic Model
**CWE Reference:** CWE-XXX (if applicable)
**Status:** RESOLVED / ACCEPTED RISK / MITIGATED

**Description:**
[What was found]

**Impact:**
[Potential consequences]

**Remediation:**
[What was done to fix it]

**Verification:**
[How we verified the fix]

---
```

**Consolidate findings from:**
- Phase 5: bigint-buffer vulnerability (ACCEPTED - Solana dependency)
- Phase 6: Sealevel attacks, round state machine, Pyth oracle (all RESOLVED)
- Phase 7: Input validation, TOCTOU races (all RESOLVED)
- Phase 8: Type safety improvements (RESOLVED)
- Phase 9: Multi-sig implementation (IMPLEMENTED)

**Include sections:**
- Accepted Risks (with justification)
- Known Limitations (e.g., single-authority before multi-sig)
- Recommendations for External Audit
- References to detailed phase reports

Format for external audience (security auditors, investors).
  </action>
  <verify>
- docs/SECURITY-AUDIT-REPORT.md exists with all sections
- All v1.1 findings consolidated with severity ratings
- Accepted risks documented with justification
  </verify>
  <done>
Security audit report consolidates all v1.1 findings. Ready for external review or investor due diligence.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. scripts/setup-multisig.ts creates Squads 2-of-3 multi-sig
2. scripts/transfer-authority-to-multisig.ts transfers authority via two-step process
3. docs/MULTISIG-SETUP.md provides complete operational guidance
4. docs/SECURITY-AUDIT-REPORT.md consolidates all v1.1 audit findings
5. npm run typecheck passes
</verification>

<success_criteria>
- Multi-sig scripts ready for deployment execution (not run, just prepared)
- Operational runbook enables team to manage multi-sig operations
- Security audit report is investor/auditor-ready
- Single-point-of-failure risk documented with mitigation plan
- Authority key security requirement (INT-02) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration/09-02-SUMMARY.md`
</output>
