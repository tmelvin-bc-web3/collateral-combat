---
phase: 10-battle-core
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - web/src/components/battle/PnLComparisonBar.tsx
  - web/src/components/battle/types.ts
  - web/src/components/BattleArena.tsx
autonomous: true

must_haves:
  truths:
    - "Tug-of-war bar shows who is ahead with visual indicator"
    - "Bar position moves based on PnL delta between fighters"
    - "Danger zones at edges indicate near-loss positions"
    - "Center represents tied state"
    - "PnLComparisonBar is rendered in BattleArena with battle state props"
  artifacts:
    - path: "web/src/components/battle/PnLComparisonBar.tsx"
      provides: "Tug-of-war visualization"
      min_lines: 80
  key_links:
    - from: "web/src/components/battle/PnLComparisonBar.tsx"
      to: "BattleArena"
      via: "Component receives userPnL and opponentPnL props"
      pattern: "PnLComparisonBar"
    - from: "web/src/components/BattleArena.tsx"
      to: "web/src/components/battle/PnLComparisonBar.tsx"
      via: "Import and render with battle state"
      pattern: "import.*PnLComparisonBar.*from.*battle"
---

<objective>
Enhance PnL comparison bar with tug-of-war visualization

Purpose: Per CONTEXT.md, use a tug-of-war bar showing who's ahead visually. Research found this makes battles 10x more watchable. The indicator should make it obvious at a glance who is winning.
Output: Enhanced PnLComparisonBar with tug-of-war physics-style indicator, wired into BattleArena
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-battle-core/10-CONTEXT.md
@.planning/phases/10-battle-core/10-RESEARCH.md

# Source code for enhancement
@web/src/components/battle/PnLComparisonBar.tsx
@web/src/components/battle/types.ts
@web/src/components/BattleArena.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign PnL bar as tug-of-war indicator</name>
  <files>
    web/src/components/battle/PnLComparisonBar.tsx
    web/src/components/battle/types.ts
  </files>
  <action>
Replace the current PnLComparisonBar with a true tug-of-war design:

1. Update types.ts to extend props:
```typescript
export interface PnLComparisonBarProps {
  userPnL: number;       // Percentage (-100 to +100)
  opponentPnL: number;   // Percentage
  userPnLDollar: number;
  opponentPnLDollar: number;
  userWallet?: string;   // For display
  opponentWallet?: string;
}
```

2. Rewrite PnLComparisonBar.tsx:
```tsx
'use client';

import { ChevronLeft, ChevronRight, Skull, Trophy } from 'lucide-react';
import { PnLComparisonBarProps } from './types';

export function PnLComparisonBar({
  userPnL,
  opponentPnL,
  userPnLDollar,
  opponentPnLDollar,
}: PnLComparisonBarProps) {
  // Calculate delta - positive means user is ahead
  const delta = userPnL - opponentPnL;
  const absDelta = Math.abs(delta);

  // Determine leader
  const leader = delta > 0.01 ? 'user' : delta < -0.01 ? 'opponent' : 'tied';

  // Convert delta to rope position (50% = center/tied)
  // Clamp delta effect: max swing is 40% in either direction
  const maxSwing = 40;
  const clampedDelta = Math.max(-maxSwing, Math.min(maxSwing, delta * 2));
  const ropePosition = 50 + clampedDelta;

  // Calculate danger level (0-1, where 1 = about to lose)
  // If rope is within 10% of edge, show danger
  const userDanger = Math.max(0, (90 - ropePosition) / 10);
  const opponentDanger = Math.max(0, (ropePosition - 10) / 10);
  const isUserInDanger = ropePosition > 80;
  const isOpponentInDanger = ropePosition < 20;

  return (
    <div className="w-full px-4 py-4 bg-gradient-to-b from-black/80 to-black/40 backdrop-blur border-b border-white/10">
      {/* Fighter Labels */}
      <div className="flex justify-between items-center mb-3">
        {/* User Side */}
        <div className="flex items-center gap-2">
          <div className={`w-3 h-3 rounded-full ${leader === 'user' ? 'bg-success animate-pulse' : 'bg-success/50'}`} />
          <span className="text-xs font-bold text-white/60 uppercase tracking-wider">You</span>
        </div>

        {/* Status */}
        <div className={`px-3 py-1 rounded-full text-xs font-black uppercase tracking-wider ${
          leader === 'user'
            ? 'bg-success/20 text-success'
            : leader === 'opponent'
            ? 'bg-danger/20 text-danger'
            : 'bg-white/10 text-white/60'
        }`}>
          {leader === 'user' ? (
            <span className="flex items-center gap-1">
              <ChevronLeft className="w-3 h-3" /> WINNING +{absDelta.toFixed(1)}%
            </span>
          ) : leader === 'opponent' ? (
            <span className="flex items-center gap-1">
              LOSING -{absDelta.toFixed(1)}% <ChevronRight className="w-3 h-3" />
            </span>
          ) : (
            'TIED'
          )}
        </div>

        {/* Opponent Side */}
        <div className="flex items-center gap-2">
          <span className="text-xs font-bold text-white/60 uppercase tracking-wider">Opponent</span>
          <div className={`w-3 h-3 rounded-full ${leader === 'opponent' ? 'bg-danger animate-pulse' : 'bg-danger/50'}`} />
        </div>
      </div>

      {/* Tug of War Bar */}
      <div className="relative h-10 rounded-lg overflow-hidden bg-gradient-to-r from-success/20 via-transparent to-danger/20">
        {/* Danger Zones */}
        <div className={`absolute left-0 top-0 bottom-0 w-[15%] bg-gradient-to-r from-success to-transparent transition-opacity ${isOpponentInDanger ? 'opacity-100' : 'opacity-30'}`}>
          {isOpponentInDanger && (
            <div className="absolute inset-0 flex items-center justify-center">
              <Trophy className="w-5 h-5 text-success animate-pulse" />
            </div>
          )}
        </div>
        <div className={`absolute right-0 top-0 bottom-0 w-[15%] bg-gradient-to-l from-danger to-transparent transition-opacity ${isUserInDanger ? 'opacity-100' : 'opacity-30'}`}>
          {isUserInDanger && (
            <div className="absolute inset-0 flex items-center justify-center">
              <Skull className="w-5 h-5 text-danger animate-pulse" />
            </div>
          )}
        </div>

        {/* Center Line */}
        <div className="absolute left-1/2 top-0 bottom-0 w-0.5 bg-white/30 transform -translate-x-1/2" />

        {/* Rope Indicator (the moving part) */}
        <div
          className="absolute top-1/2 transform -translate-y-1/2 transition-all duration-300 ease-out"
          style={{ left: `${ropePosition}%` }}
        >
          {/* Rope line connecting to edges */}
          <div
            className="absolute top-1/2 h-1 bg-gradient-to-r from-success via-warning to-danger transform -translate-y-1/2"
            style={{
              left: `calc(-${ropePosition}vw + 1rem)`,
              right: `calc(-${100 - ropePosition}vw + 1rem)`,
              width: 'calc(100vw - 2rem)',
            }}
          />

          {/* Center knot/indicator */}
          <div className={`relative z-10 w-6 h-6 rounded-full border-4 transform -translate-x-1/2 shadow-lg transition-colors ${
            leader === 'user'
              ? 'bg-success border-success/50 shadow-success/30'
              : leader === 'opponent'
              ? 'bg-danger border-danger/50 shadow-danger/30'
              : 'bg-warning border-warning/50 shadow-warning/30'
          }`}>
            <div className="absolute inset-0 rounded-full animate-ping opacity-30 bg-current" />
          </div>
        </div>

        {/* Tick marks */}
        {[25, 50, 75].map(pos => (
          <div
            key={pos}
            className="absolute top-0 bottom-0 w-px bg-white/10"
            style={{ left: `${pos}%` }}
          />
        ))}
      </div>

      {/* PnL Numbers */}
      <div className="flex justify-between mt-3">
        <div className="text-left">
          <div className={`text-2xl font-black tabular-nums ${userPnL >= 0 ? 'text-success' : 'text-danger'}`}>
            {userPnL >= 0 ? '+' : ''}{userPnL.toFixed(2)}%
          </div>
          <div className="text-xs text-white/40">
            {userPnLDollar >= 0 ? '+' : ''}${Math.abs(userPnLDollar).toFixed(2)}
          </div>
        </div>

        <div className="text-right">
          <div className={`text-2xl font-black tabular-nums ${opponentPnL >= 0 ? 'text-success' : 'text-danger'}`}>
            {opponentPnL >= 0 ? '+' : ''}{opponentPnL.toFixed(2)}%
          </div>
          <div className="text-xs text-white/40">
            {opponentPnLDollar >= 0 ? '+' : ''}${Math.abs(opponentPnLDollar).toFixed(2)}
          </div>
        </div>
      </div>
    </div>
  );
}
```

Key design decisions:
- Rope position is based on PnL DELTA (not absolute PnL)
- Center (50%) = tied
- Left = user winning, Right = opponent winning
- Danger zones at edges (Trophy for near-win, Skull for near-loss)
- Smooth transition animation on position changes
- Color-coded indicator knot (green/red/orange)
  </action>
  <verify>
TypeScript compiles: `cd web && pnpm typecheck`
Component renders in browser without errors
  </verify>
  <done>
PnLComparisonBar shows tug-of-war visualization with moving rope indicator, danger zones, and clear winner display
  </done>
</task>

<task type="auto">
  <name>Task 2: Add responsive styling and animation polish</name>
  <files>
    web/src/components/battle/PnLComparisonBar.tsx
  </files>
  <action>
Add mobile-responsive styles and animation improvements:

1. Add CSS animations for the rope line:
```tsx
// Add to the component, before return
const ropeStyle = {
  backgroundImage: 'repeating-linear-gradient(90deg, transparent, transparent 4px, rgba(255,255,255,0.1) 4px, rgba(255,255,255,0.1) 8px)',
};
```

2. Add media query responsive adjustments via Tailwind:
- On mobile (sm:), reduce padding and font sizes
- Hide the tick marks on mobile
- Simplify the status indicator

Update the component to include:
```tsx
{/* Status - simplified on mobile */}
<div className={`px-2 sm:px-3 py-1 rounded-full text-[10px] sm:text-xs font-black uppercase tracking-wider ${
  // ... same as before
}`}>
  <span className="hidden sm:inline">{/* Full text */}</span>
  <span className="sm:hidden">{/* Abbreviated text */}</span>
</div>
```

3. Add spring-like easing for more natural movement:
```tsx
// In the rope indicator div:
style={{
  left: `${ropePosition}%`,
  transition: 'left 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)', // spring effect
}}
```

4. Add subtle shake animation when in danger zone:
```tsx
const shakeClass = isUserInDanger || isOpponentInDanger ? 'animate-shake' : '';

// Add to a global CSS or inline style:
// @keyframes shake { 0%, 100% { transform: translateX(0) } 25% { transform: translateX(-2px) } 75% { transform: translateX(2px) } }
```

Actually, add a simple CSS-in-JS approach with inline styles or use Tailwind's built-in animate classes.
  </action>
  <verify>
`cd web && pnpm typecheck` passes
Component renders correctly on mobile viewport (375px width)
  </verify>
  <done>
PnL bar is responsive on mobile, has smooth spring animation, and danger zones provide visual feedback
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire PnLComparisonBar into BattleArena</name>
  <files>
    web/src/components/BattleArena.tsx
  </files>
  <action>
Ensure PnLComparisonBar is properly imported and rendered in BattleArena with the correct props from battle state.

1. Verify the import exists at the top of BattleArena.tsx:
```tsx
import {
  BattleHeader,
  PnLComparisonBar,
  OpponentActivityFeed,
  ForfeitButton,
  FighterData,
  ActivityEvent,
  BattlePhase,
} from './battle';
```

2. Verify PnLComparisonBar is rendered with battle state props (should be after BattleHeader, before main layout):
```tsx
{/* P&L Comparison Bar - Only for PvP battles */}
{!isSoloPractice && (
  <PnLComparisonBar
    userPnL={userPnL.percent}
    opponentPnL={opponentPnL.percent}
    userPnLDollar={userPnL.dollar}
    opponentPnLDollar={opponentPnL.dollar}
  />
)}
```

3. Verify the userPnL and opponentPnL values are calculated from the battle state:
- userPnL should come from getTotalPnL() which calculates from currentPlayer positions
- opponentPnL should come from getOpponentPnL() which calculates from opponent positions

If the wiring already exists (check BattleArena.tsx), document that it's correct. If any part is missing:
- Add the import if missing
- Add the component render if missing
- Ensure props match the updated PnLComparisonBarProps interface

The key wiring is: Battle state (positions, prices) -> PnL calculations -> PnLComparisonBar props
  </action>
  <verify>
`cd web && pnpm typecheck` passes
`cd web && pnpm build` succeeds
PnLComparisonBar renders in BattleArena during an active PvP battle
  </verify>
  <done>
PnLComparisonBar is imported from './battle' index and rendered in BattleArena with userPnL.percent, opponentPnL.percent, userPnL.dollar, opponentPnL.dollar props derived from battle state
  </done>
</task>

</tasks>

<verification>
- [ ] `cd web && pnpm typecheck` passes
- [ ] `cd web && pnpm build` succeeds
- [ ] Component shows rope in center when PnL delta is 0
- [ ] Rope moves left when user is ahead
- [ ] Rope moves right when opponent is ahead
- [ ] Danger zones light up near edges
- [ ] Animations are smooth (no jank)
- [ ] Displays correctly on mobile viewport
- [ ] PnLComparisonBar is wired into BattleArena with battle state props
</verification>

<success_criteria>
1. Tug-of-war bar clearly shows who is winning at a glance
2. Delta between fighters determines rope position
3. Center means tied
4. Danger zones warn of near-loss
5. Spring animation makes movement feel natural
6. Mobile responsive without breaking layout
7. Numbers still visible below the bar
8. Component is properly wired into BattleArena with real battle data
</success_criteria>

<output>
After completion, create `.planning/phases/10-battle-core/10-05-SUMMARY.md`
</output>
