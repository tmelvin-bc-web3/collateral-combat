---
phase: 10-battle-core
plan: 06
type: execute
wave: 2
depends_on: []
files_modified:
  - web/src/components/battle/LiquidationIndicator.tsx
  - web/src/components/battle/PositionsTable.tsx
  - web/src/components/battle/types.ts
  - backend/src/services/battleManager.ts
autonomous: true

must_haves:
  truths:
    - "Liquidation distance shows as percentage from current price"
    - "Indicator changes color as liquidation approaches (green -> yellow -> red)"
    - "Both fighters' liquidation distances are visible"
    - "Visual warning when within 5% of liquidation"
  artifacts:
    - path: "web/src/components/battle/LiquidationIndicator.tsx"
      provides: "Liquidation distance display component"
      exports: ["LiquidationIndicator"]
    - path: "backend/src/services/battleManager.ts"
      provides: "Liquidation distance calculation in position data"
      contains: "liquidationDistance"
  key_links:
    - from: "web/src/components/battle/PositionsTable.tsx"
      to: "LiquidationIndicator"
      via: "Component renders for each position"
      pattern: "LiquidationIndicator"
    - from: "backend/src/services/battleManager.ts"
      to: "position.liquidationDistance"
      via: "Calculated in updateAccountValue"
      pattern: "liquidationDistance"
---

<objective>
Add liquidation distance indicator to battle UI

Purpose: Per CONTEXT.md, show liquidation distance for both fighters. This helps spectators understand the risk each fighter is taking and creates tension as positions approach liquidation.
Output: LiquidationIndicator component, calculation in backend, integration in PositionsTable
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-battle-core/10-CONTEXT.md
@.planning/phases/10-battle-core/10-RESEARCH.md

# Source code for modification
@backend/src/services/battleManager.ts
@web/src/components/battle/PositionsTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add liquidation distance calculation to backend</name>
  <files>
    backend/src/services/battleManager.ts
    backend/src/types.ts
  </files>
  <action>
1. Update PerpPosition interface in types.ts to include liquidation distance:
```typescript
export interface PerpPosition {
  // ... existing fields ...
  liquidationDistance: number;  // Percentage distance to liquidation (e.g., 5.2 = 5.2% away)
}
```

2. Modify updateAccountValue() in battleManager.ts to calculate liquidation distance:
```typescript
private updateAccountValue(player: BattlePlayer): boolean {
  let totalUnrealizedPnl = 0;
  let hadLiquidation = false;

  player.account.positions.forEach(position => {
    const currentPrice = priceService.getPrice(position.asset);
    position.currentPrice = currentPrice;

    // Calculate unrealized P&L
    const priceChange = (currentPrice - position.entryPrice) / position.entryPrice;
    const pnlPercent = position.side === 'long' ? priceChange : -priceChange;
    position.unrealizedPnlPercent = pnlPercent * position.leverage * 100;
    position.unrealizedPnl = position.size * pnlPercent * position.leverage;

    // Calculate liquidation distance as percentage
    if (position.side === 'long') {
      // For long: distance = (current - liq) / current * 100
      position.liquidationDistance = ((currentPrice - position.liquidationPrice) / currentPrice) * 100;
    } else {
      // For short: distance = (liq - current) / current * 100
      position.liquidationDistance = ((position.liquidationPrice - currentPrice) / currentPrice) * 100;
    }

    totalUnrealizedPnl += position.unrealizedPnl;

    // Check for liquidation
    if (position.side === 'long' && currentPrice <= position.liquidationPrice) {
      this.liquidatePosition(player, position);
      hadLiquidation = true;
    } else if (position.side === 'short' && currentPrice >= position.liquidationPrice) {
      this.liquidatePosition(player, position);
      hadLiquidation = true;
    }
  });

  // ... rest of existing code ...
  return hadLiquidation;
}
```

3. Also update openPosition() to set initial liquidation distance:
```typescript
// After creating the position object:
const position: PerpPosition = {
  // ... existing fields ...
  liquidationDistance: side === 'long'
    ? ((currentPrice - liquidationPrice) / currentPrice) * 100
    : ((liquidationPrice - currentPrice) / currentPrice) * 100,
};
```
  </action>
  <verify>
TypeScript compiles: `cd backend && npm run typecheck`
  </verify>
  <done>
Position objects include liquidationDistance as percentage, calculated every price tick
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LiquidationIndicator component</name>
  <files>
    web/src/components/battle/LiquidationIndicator.tsx
    web/src/components/battle/types.ts
  </files>
  <action>
1. Add type to types.ts:
```typescript
export interface LiquidationIndicatorProps {
  distance: number;  // Percentage from liquidation (e.g., 5.2)
  side: 'long' | 'short';
}
```

2. Create LiquidationIndicator.tsx:
```tsx
'use client';

import { AlertTriangle, Skull, Shield } from 'lucide-react';
import { LiquidationIndicatorProps } from './types';

export function LiquidationIndicator({ distance, side }: LiquidationIndicatorProps) {
  // Determine danger level based on distance
  // < 2% = critical (red, skull)
  // 2-5% = warning (orange, triangle)
  // 5-10% = caution (yellow)
  // > 10% = safe (green, shield)

  const getStatus = () => {
    if (distance <= 2) return { level: 'critical', color: 'text-danger', bgColor: 'bg-danger/20', icon: Skull };
    if (distance <= 5) return { level: 'warning', color: 'text-warning', bgColor: 'bg-warning/20', icon: AlertTriangle };
    if (distance <= 10) return { level: 'caution', color: 'text-yellow-400', bgColor: 'bg-yellow-400/20', icon: AlertTriangle };
    return { level: 'safe', color: 'text-success', bgColor: 'bg-success/20', icon: Shield };
  };

  const status = getStatus();
  const Icon = status.icon;

  // Calculate bar fill (inverse - lower distance = more filled)
  // At 0% distance, bar is 100% full
  // At 20%+ distance, bar is empty
  const fillPercent = Math.max(0, 100 - (distance * 5)); // 0% distance = 100% fill, 20% distance = 0% fill

  return (
    <div className={`flex items-center gap-2 px-2 py-1 rounded ${status.bgColor}`}>
      {/* Icon */}
      <Icon className={`w-3.5 h-3.5 ${status.color} ${status.level === 'critical' ? 'animate-pulse' : ''}`} />

      {/* Progress bar */}
      <div className="w-16 h-1.5 bg-black/30 rounded-full overflow-hidden">
        <div
          className={`h-full rounded-full transition-all duration-300 ${
            status.level === 'critical' ? 'bg-danger animate-pulse' :
            status.level === 'warning' ? 'bg-warning' :
            status.level === 'caution' ? 'bg-yellow-400' :
            'bg-success'
          }`}
          style={{ width: `${fillPercent}%` }}
        />
      </div>

      {/* Distance text */}
      <span className={`text-xs font-mono font-bold tabular-nums ${status.color}`}>
        {distance.toFixed(1)}%
      </span>

      {/* Direction indicator */}
      <span className="text-[10px] text-white/40 uppercase">
        to liq
      </span>
    </div>
  );
}
```
  </action>
  <verify>
TypeScript compiles: `cd web && pnpm typecheck`
  </verify>
  <done>
LiquidationIndicator component shows distance with color-coded status and progress bar
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate liquidation indicator into PositionsTable</name>
  <files>
    web/src/components/battle/PositionsTable.tsx
  </files>
  <action>
1. Import the new component:
```typescript
import { LiquidationIndicator } from './LiquidationIndicator';
```

2. Update the table to include a liquidation column. Find the existing PositionsTable component and add:

In the table header, add a new column:
```tsx
<th className="text-right">Liq Distance</th>
```

In the table row for each position:
```tsx
<td className="text-right">
  <LiquidationIndicator
    distance={position.liquidationDistance}
    side={position.side}
  />
</td>
```

3. If PositionsTable doesn't exist or has different structure, adapt accordingly. The key integration points:
- Import LiquidationIndicator
- Pass position.liquidationDistance and position.side as props
- Position the indicator visibly per position row

4. Also add indicator to opponent's positions view if displayed separately. The indicator should be visible for BOTH fighters' positions per CONTEXT.md requirement.
  </action>
  <verify>
TypeScript compiles: `cd web && pnpm typecheck`
Build succeeds: `cd web && pnpm build`
  </verify>
  <done>
PositionsTable shows liquidation distance indicator for each position, visible for both fighters
  </done>
</task>

</tasks>

<verification>
- [ ] `cd backend && npm run typecheck` passes
- [ ] `cd web && pnpm typecheck` passes
- [ ] `cd web && pnpm build` succeeds
- [ ] Position objects include liquidationDistance field
- [ ] Indicator shows green when > 10% from liquidation
- [ ] Indicator shows yellow when 5-10% from liquidation
- [ ] Indicator shows orange when 2-5% from liquidation
- [ ] Indicator shows red with skull when < 2% from liquidation
</verification>

<success_criteria>
1. Liquidation distance calculated correctly for long and short positions
2. Distance updates every price tick
3. Indicator colors match danger levels
4. Critical indicator pulses/animates
5. Both fighters' positions show the indicator
6. Progress bar inversely correlates with distance (closer = more filled)
</success_criteria>

<output>
After completion, create `.planning/phases/10-battle-core/10-06-SUMMARY.md`
</output>
