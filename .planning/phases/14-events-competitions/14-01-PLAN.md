---
phase: 14-events-competitions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/eventDatabase.ts
  - backend/src/services/eventManager.ts
  - backend/src/types.ts
  - backend/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Events can be created with scheduled start times"
    - "Events have a main card structure with featured battles"
    - "Admin can create events via API"
  artifacts:
    - path: "backend/src/db/eventDatabase.ts"
      provides: "Event persistence layer"
      exports: ["createEvent", "getEvent", "getUpcomingEvents", "addEventBattle", "subscribeToEvent"]
    - path: "backend/src/services/eventManager.ts"
      provides: "Event lifecycle management"
      exports: ["eventManager"]
  key_links:
    - from: "backend/src/services/eventManager.ts"
      to: "backend/src/db/eventDatabase.ts"
      via: "database operations"
      pattern: "db\\.(create|get|add)"
    - from: "backend/src/index.ts"
      to: "backend/src/services/eventManager.ts"
      via: "initialization"
      pattern: "eventManager\\.initialize"
---

<objective>
Create the event database schema and manager service for fight cards.

Purpose: Enable scheduled events with featured battles and admin creation capability, forming the foundation for the events system (EVENT-01, EVENT-04).

Output: eventDatabase.ts with schema and CRUD operations, eventManager.ts singleton with lifecycle management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-events-competitions/14-RESEARCH.md

Key patterns from existing codebase:
@backend/src/services/scheduledMatchManager.ts - Event scheduling pattern with cron and ticker
@backend/src/db/notificationDatabase.ts - Database pattern with prepared statements
@backend/src/services/ldsManager.ts - Game lifecycle pattern with state machine
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Event Database Schema</name>
  <files>backend/src/db/eventDatabase.ts</files>
  <action>
Create eventDatabase.ts following the notificationDatabase.ts pattern with:

Schema tables:
1. `events` table:
   - id TEXT PRIMARY KEY
   - name TEXT NOT NULL
   - description TEXT
   - scheduled_start_time INTEGER NOT NULL (UTC timestamp)
   - registration_opens INTEGER NOT NULL
   - registration_closes INTEGER NOT NULL
   - status TEXT NOT NULL DEFAULT 'upcoming' (upcoming, registration_open, in_progress, completed, cancelled)
   - entry_fee_lamports INTEGER NOT NULL
   - max_participants INTEGER NOT NULL
   - prize_pool_lamports INTEGER DEFAULT 0
   - created_at INTEGER NOT NULL
   - created_by TEXT NOT NULL (admin wallet)

2. `event_battles` table:
   - id TEXT PRIMARY KEY
   - event_id TEXT NOT NULL (FK to events)
   - position INTEGER NOT NULL (order on card)
   - player1_wallet TEXT NOT NULL
   - player2_wallet TEXT NOT NULL
   - battle_id TEXT (links to actual battle when created)
   - is_main_event INTEGER DEFAULT 0 (boolean)
   - status TEXT NOT NULL DEFAULT 'scheduled' (scheduled, in_progress, completed, cancelled)
   - FOREIGN KEY (event_id) REFERENCES events(id)

3. `event_subscriptions` table:
   - wallet_address TEXT NOT NULL
   - event_id TEXT NOT NULL
   - notified INTEGER DEFAULT 0 (tracks if 5-min notification sent)
   - subscribed_at INTEGER NOT NULL
   - PRIMARY KEY (wallet_address, event_id)

Prepared statements for:
- createEvent, getEvent, getEventById, getUpcomingEvents, updateEventStatus
- addEventBattle, getEventBattles, updateBattleStatus
- subscribeToEvent, unsubscribeFromEvent, getEventSubscribers, markNotified, getUnnotifiedSubscribers

Export all functions following existing patterns.
  </action>
  <verify>TypeScript compiles: `cd backend && npx tsc --noEmit`</verify>
  <done>eventDatabase.ts exists with all tables and prepared statements, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Create Event Manager Service</name>
  <files>backend/src/services/eventManager.ts, backend/src/types.ts</files>
  <action>
Create eventManager.ts singleton following scheduledMatchManager.ts pattern:

1. Add types to backend/src/types.ts:
```typescript
export type EventStatus = 'upcoming' | 'registration_open' | 'in_progress' | 'completed' | 'cancelled';
export type EventBattleStatus = 'scheduled' | 'in_progress' | 'completed' | 'cancelled';

export interface FightCardEvent {
  id: string;
  name: string;
  description?: string;
  scheduledStartTime: number;
  registrationOpens: number;
  registrationCloses: number;
  status: EventStatus;
  entryFeeLamports: number;
  maxParticipants: number;
  prizePoolLamports: number;
  createdAt: number;
  createdBy: string;
}

export interface EventBattle {
  id: string;
  eventId: string;
  position: number;
  player1Wallet: string;
  player2Wallet: string;
  battleId?: string;
  isMainEvent: boolean;
  status: EventBattleStatus;
}

export interface EventManagerEvent {
  type: 'event_created' | 'event_updated' | 'registration_opened' | 'event_starting' | 'event_started' | 'event_completed' | 'event_cancelled' | 'battle_starting';
  eventId: string;
  data: any;
}
```

2. Create eventManager.ts class with:
- Private state: Map for event timers, Set for listeners, initialized flag
- initialize(): Start ticker that checks event states every 60 seconds
- tick(): Check all events for state transitions (registration open, starting, etc.)
- createEvent(config): Admin-only event creation, validate start time is future
- addBattleToCard(eventId, player1, player2, isMainEvent): Add battle to event
- subscribeToEvent(eventId, wallet): User subscribes for notifications
- getUpcomingEvents(): Return sorted list of upcoming events
- getEvent(id): Return single event with battles
- emit(event): Notify all listeners
- subscribe/unsubscribe listeners

Configuration constants:
- REGISTRATION_OPENS_HOURS_BEFORE = 24
- REGISTRATION_CLOSES_MINUTES_BEFORE = 30
- EVENT_START_NOTIFICATION_MINUTES = 5

Export singleton: `export const eventManager = new EventManager();`
  </action>
  <verify>TypeScript compiles: `cd backend && npx tsc --noEmit`</verify>
  <done>eventManager.ts singleton exists with lifecycle management, types added to types.ts</done>
</task>

<task type="auto">
  <name>Task 3: Wire Event Manager to Backend</name>
  <files>backend/src/index.ts</files>
  <action>
Integrate eventManager into the backend server:

1. Import eventManager at top of file:
```typescript
import { eventManager } from './services/eventManager';
```

2. Initialize in server startup (after other managers like ldsManager):
```typescript
// Initialize Event Manager (Fight Cards)
eventManager.initialize();
```

3. Add REST endpoints for events:
- GET /api/events - List upcoming events (public)
- GET /api/events/:id - Get single event with battles (public)
- POST /api/events - Create event (admin-only, check ADMIN_WALLETS)
- POST /api/events/:id/battles - Add battle to card (admin-only)
- POST /api/events/:id/subscribe - Subscribe to event (authenticated)
- DELETE /api/events/:id/subscribe - Unsubscribe (authenticated)

4. Add WebSocket events:
- Subscribe eventManager to emit events to socket.io rooms
- Create room per event: `event:${eventId}`
- Emit event_update when status changes

Admin validation pattern (existing in codebase):
```typescript
const adminWallets = process.env.ADMIN_WALLETS?.split(',') || [];
if (!adminWallets.includes(wallet)) {
  return res.status(403).json({ error: 'Admin access required' });
}
```
  </action>
  <verify>`cd backend && npm run dev` starts without errors, endpoints return data</verify>
  <done>Event endpoints respond, eventManager initializes on startup</done>
</task>

</tasks>

<verification>
1. Backend compiles: `cd backend && npx tsc --noEmit`
2. Backend starts: `cd backend && npm run dev`
3. Create event via curl (assuming admin wallet configured):
   `curl -X POST http://localhost:3001/api/events -H "Content-Type: application/json" -d '{"name":"Test Fight Night","scheduledStartTime":...}'`
4. List events: `curl http://localhost:3001/api/events`
</verification>

<success_criteria>
- eventDatabase.ts creates tables on init
- eventManager.ts initializes and starts ticker
- REST endpoints for CRUD operations work
- WebSocket room setup for event updates
- Admin-only endpoints properly gated
</success_criteria>

<output>
After completion, create `.planning/phases/14-events-competitions/14-01-SUMMARY.md`
</output>
