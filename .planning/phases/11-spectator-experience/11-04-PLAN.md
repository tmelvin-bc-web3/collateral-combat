---
phase: 11-spectator-experience
plan: 04
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - web/src/components/spectate/QuickBetStrip.tsx
  - web/src/components/BettingPanel.tsx
  - web/src/app/spectate/page.tsx
autonomous: true

must_haves:
  truths:
    - "Spectator can place one-tap bet from quick bet strip at bottom of screen"
    - "Quick bet strip shows both fighters with current odds"
    - "Small odds changes (<5%) are auto-accepted without interruption"
    - "Pool visualization shows A vs B betting split"
  artifacts:
    - path: "web/src/components/spectate/QuickBetStrip.tsx"
      provides: "Mobile-optimized one-tap betting component"
      exports: ["QuickBetStrip"]
    - path: "web/src/components/BettingPanel.tsx"
      provides: "Enhanced betting panel with pool visualization and auto-accept"
      contains: ["auto-accept", "pool visualization"]
  key_links:
    - from: "web/src/app/spectate/page.tsx"
      to: "QuickBetStrip"
      via: "render at bottom for mobile"
      pattern: "<QuickBetStrip"
    - from: "QuickBetStrip"
      to: "socket.emit('place_bet'"
      via: "place bet on click"
      pattern: "socket.emit.*place_bet"
---

<objective>
Create QuickBetStrip for one-tap mobile betting, add auto-accept odds logic, and pool visualization.

Purpose: Mobile users need frictionless betting without modal dialogs. Auto-accept prevents annoying interruptions for small odds changes. Pool visualization shows betting momentum.

Output: QuickBetStrip component, enhanced BettingPanel with pool viz and auto-accept.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-spectator-experience/11-RESEARCH.md

# Existing betting components
@web/src/components/BettingPanel.tsx
@web/src/components/stands/BattleCard.tsx
@web/src/lib/socket.ts
@web/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuickBetStrip component</name>
  <files>web/src/components/spectate/QuickBetStrip.tsx</files>
  <action>
Create a mobile-optimized one-tap betting strip that appears at the bottom of the screen.

```typescript
'use client';

import { useState } from 'react';
import { LiveBattle, BattleOdds } from '@/types';
import { getSocket } from '@/lib/socket';

interface QuickBetStripProps {
  battle: LiveBattle;
  odds: BattleOdds | null;
  walletAddress?: string;
  onBetPlaced?: () => void;
}

const QUICK_BET_AMOUNTS = [0.1, 0.25, 0.5, 1];

export function QuickBetStrip({ battle, odds, walletAddress, onBetPlaced }: QuickBetStripProps) {
  const [selectedAmount, setSelectedAmount] = useState(0.25);
  const [isPlacing, setIsPlacing] = useState(false);

  const player1 = battle.players[0];
  const player2 = battle.players[1];

  const formatWallet = (addr: string) => `${addr.slice(0, 4)}...${addr.slice(-4)}`;

  const handleQuickBet = (playerWallet: string) => {
    if (!walletAddress) {
      // Could emit toast or handle differently
      return;
    }

    setIsPlacing(true);
    const socket = getSocket();
    socket.emit('place_bet', battle.id, playerWallet, selectedAmount, walletAddress);

    // Optimistic UI - assume success
    setTimeout(() => {
      setIsPlacing(false);
      onBetPlaced?.();
    }, 500);
  };

  const player1Odds = odds?.player1.odds ?? 2.0;
  const player2Odds = odds?.player2.odds ?? 2.0;

  return (
    <div className="fixed bottom-0 left-0 right-0 z-40 lg:hidden">
      {/* Glass background */}
      <div className="bg-black/90 backdrop-blur-lg border-t border-white/10 safe-area-bottom">
        <div className="max-w-lg mx-auto px-3 py-2">
          {/* Amount selector row */}
          <div className="flex items-center gap-2 mb-2">
            <span className="text-[10px] text-white/40 uppercase tracking-wider">Quick Bet</span>
            <div className="flex gap-1 flex-1 justify-end">
              {QUICK_BET_AMOUNTS.map(amt => (
                <button
                  key={amt}
                  onClick={() => setSelectedAmount(amt)}
                  className={`px-2.5 py-1 rounded-md text-xs font-bold transition-all ${
                    selectedAmount === amt
                      ? 'bg-accent text-black'
                      : 'bg-white/10 text-white/60 active:bg-white/20'
                  }`}
                >
                  {amt}
                </button>
              ))}
            </div>
          </div>

          {/* Fighter bet buttons */}
          <div className="flex gap-2">
            <button
              onClick={() => player1 && handleQuickBet(player1.walletAddress)}
              disabled={isPlacing || !walletAddress || !player1}
              className="flex-1 py-3 rounded-xl bg-success/20 border border-success/30
                       active:scale-95 transition-all disabled:opacity-50 touch-manipulation"
            >
              <div className="flex flex-col items-center">
                <span className="text-success font-bold text-sm">
                  {player1 ? formatWallet(player1.walletAddress) : '---'}
                </span>
                <span className="text-success/80 text-xs font-mono">
                  {player1Odds.toFixed(2)}x
                </span>
              </div>
            </button>

            <button
              onClick={() => player2 && handleQuickBet(player2.walletAddress)}
              disabled={isPlacing || !walletAddress || !player2}
              className="flex-1 py-3 rounded-xl bg-danger/20 border border-danger/30
                       active:scale-95 transition-all disabled:opacity-50 touch-manipulation"
            >
              <div className="flex flex-col items-center">
                <span className="text-danger font-bold text-sm">
                  {player2 ? formatWallet(player2.walletAddress) : '---'}
                </span>
                <span className="text-danger/80 text-xs font-mono">
                  {player2Odds.toFixed(2)}x
                </span>
              </div>
            </button>
          </div>

          {/* Connect wallet prompt if not connected */}
          {!walletAddress && (
            <div className="text-center mt-2 text-xs text-white/40">
              Connect wallet to bet
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
```

Key features:
- Fixed at bottom, only visible on mobile (lg:hidden)
- Safe-area padding for iOS home indicator
- Quick amount presets (0.1, 0.25, 0.5, 1 SOL)
- Two large tap targets for each fighter
- Shows fighter wallet and current odds
- touch-manipulation for faster tap response
- active:scale-95 for satisfying tap feedback
  </action>
  <verify>
```bash
cd /Users/taylermelvin/Desktop/sol-battles/web && pnpm build 2>&1 | head -50
```
Component compiles without errors.
  </verify>
  <done>QuickBetStrip.tsx exists with one-tap betting interface for mobile.</done>
</task>

<task type="auto">
  <name>Task 2: Add pool visualization and auto-accept to BettingPanel</name>
  <files>web/src/components/BettingPanel.tsx</files>
  <action>
Enhance BettingPanel with pool visualization bar and auto-accept odds logic:

1. Add auto-accept constant and state at top of component:
```typescript
const AUTO_ACCEPT_THRESHOLD = 0.05; // 5%
const [lastKnownOdds, setLastKnownOdds] = useState<number | null>(null);
```

2. Add auto-accept logic in the odds_update handler:
```typescript
socket.on('odds_update', (newOdds) => {
  if (newOdds.battleId === battle.id) {
    // Check for auto-accept threshold
    if (selectedPlayer && lastKnownOdds !== null) {
      const newPlayerOdds = newOdds.player1.wallet === selectedPlayer
        ? newOdds.player1.odds
        : newOdds.player2.odds;
      const oddsChange = Math.abs((newPlayerOdds - lastKnownOdds) / lastKnownOdds);

      if (oddsChange > AUTO_ACCEPT_THRESHOLD) {
        // Show toast/notification that odds changed significantly
        // Could use a toast library or inline notification
        console.log(`Odds changed by ${(oddsChange * 100).toFixed(1)}%`);
      }
      // Otherwise auto-accept - no interruption to user
    }

    setOdds(newOdds);
    // Update lastKnownOdds when user selects a player
  }
});
```

3. Track odds when player is selected:
```typescript
// In the player selection buttons, add:
onClick={() => {
  setSelectedPlayer(player1.walletAddress);
  setLastKnownOdds(getOddsForPlayer(player1.walletAddress));
}}
```

4. Add pool visualization bar above or below the "Wager Pool Info" section.
Replace or enhance the existing pool info with a visual bar:
```tsx
{/* Pool Visualization Bar */}
{odds && odds.totalPool > 0 && (
  <div className="mt-5 pt-5 border-t border-border-primary">
    <div className="flex justify-between text-xs text-text-tertiary mb-2">
      <span>Spectator Pool</span>
      <span className="font-mono font-bold text-accent">{odds.totalPool.toFixed(2)} SOL</span>
    </div>

    {/* A vs B Split Bar */}
    <div className="flex h-8 rounded-lg overflow-hidden border border-border-primary">
      {(() => {
        const total = odds.player1.totalBacked + odds.player2.totalBacked;
        const p1Percent = total > 0 ? (odds.player1.totalBacked / total) * 100 : 50;
        const p2Percent = total > 0 ? (odds.player2.totalBacked / total) * 100 : 50;
        return (
          <>
            <div
              className="bg-success/30 flex items-center justify-center text-xs font-bold text-success transition-all duration-500"
              style={{ width: `${p1Percent}%` }}
            >
              {p1Percent >= 20 && `${p1Percent.toFixed(0)}%`}
            </div>
            <div
              className="bg-danger/30 flex items-center justify-center text-xs font-bold text-danger transition-all duration-500"
              style={{ width: `${p2Percent}%` }}
            >
              {p2Percent >= 20 && `${p2Percent.toFixed(0)}%`}
            </div>
          </>
        );
      })()}
    </div>

    {/* Labels below bar */}
    <div className="flex justify-between mt-2 text-xs">
      <span className="text-success font-mono">{odds.player1.totalBacked.toFixed(2)} SOL</span>
      <span className="text-danger font-mono">{odds.player2.totalBacked.toFixed(2)} SOL</span>
    </div>
  </div>
)}
```

This replaces the existing grid-cols-2 pool info with a more visual representation.
  </action>
  <verify>
```bash
cd /Users/taylermelvin/Desktop/sol-battles/web && pnpm build 2>&1 | head -50
```
Build passes with pool visualization and auto-accept logic.
  </verify>
  <done>BettingPanel has visual pool split bar and auto-accept odds logic (5% threshold).</done>
</task>

<task type="auto">
  <name>Task 3: Integrate QuickBetStrip into spectate page</name>
  <files>web/src/app/spectate/page.tsx</files>
  <action>
Add QuickBetStrip to the spectate page, passing battle and odds data.

1. Check the spectate page structure - it likely renders SpectatorView when a battle is selected.

2. Import QuickBetStrip:
```typescript
import { QuickBetStrip } from '@/components/spectate/QuickBetStrip';
```

3. Add QuickBetStrip at the appropriate level where battle state is available.
   If SpectatorView is rendered conditionally, add QuickBetStrip alongside it:
```tsx
{selectedBattle && (
  <>
    <SpectatorView
      battle={selectedBattle}
      onBack={handleBack}
      walletAddress={walletAddress}
    />
    <QuickBetStrip
      battle={selectedBattle}
      odds={selectedBattle.odds || null}
      walletAddress={walletAddress}
    />
  </>
)}
```

4. If the page doesn't track odds separately, the QuickBetStrip will use battle.odds directly.
   Odds updates come via WebSocket to BettingPanel, but QuickBetStrip can read from battle prop.

Note: The exact integration depends on page structure. Key requirement is that QuickBetStrip
receives battle and walletAddress props and renders at bottom of screen on mobile.
  </action>
  <verify>
```bash
cd /Users/taylermelvin/Desktop/sol-battles/web && pnpm build 2>&1 | head -50
```
Build passes. QuickBetStrip integrated into spectate page.
  </verify>
  <done>QuickBetStrip appears at bottom of spectate page on mobile viewports.</done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm build` passes in web directory
2. On mobile: QuickBetStrip visible at bottom with two fighter buttons
3. Quick bet amounts (0.1, 0.25, 0.5, 1) selectable
4. Tapping fighter button places bet without modal
5. Pool visualization shows visual A vs B split in BettingPanel
6. Small odds changes (<5%) don't interrupt betting flow
</verification>

<success_criteria>
- BET-03: QuickBetStrip enables one-tap betting on mobile
- BET-04: Auto-accept logic implemented (5% threshold)
- BET-05: Pool visualization shows A vs B split visually
- Touch-friendly tap targets on mobile
- Safe-area padding for notch/home indicator
</success_criteria>

<output>
After completion, create `.planning/phases/11-spectator-experience/11-04-SUMMARY.md`
</output>
