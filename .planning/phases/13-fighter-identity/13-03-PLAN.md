---
phase: 13-fighter-identity
plan: 03
type: execute
wave: 2
depends_on: ["13-01", "13-02"]
files_modified:
  - web/src/app/profile/[wallet]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Profile shows ELO tier badge next to level badge"
    - "Profile shows win/loss/tie record for battles"
    - "Profile shows current and best win streak"
    - "Profile shows ROI percentage"
    - "Profile shows recent form indicator (last 5 battles)"
  artifacts:
    - path: "web/src/app/profile/[wallet]/page.tsx"
      provides: "Enhanced profile with fighter stats"
      contains: "EloTierBadge"
  key_links:
    - from: "web/src/app/profile/[wallet]/page.tsx"
      to: "/api/battles/form"
      via: "fetch in useEffect"
      pattern: "fetch.*api/battles/form"
    - from: "web/src/app/profile/[wallet]/page.tsx"
      to: "@/components/profile"
      via: "import"
      pattern: "import.*EloTierBadge.*RecentFormIndicator"
---

<objective>
Enhance profile page with fighter identity stats

Purpose: Display PROF-01 (win/loss), PROF-02 (ELO badge), PROF-03 (streaks), PROF-04 (ROI), PROF-05 (trading style), PROF-06 (favorites), PROF-07 (recent form) on the profile page
Output: Extended profile page showing complete fighter statistics
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-fighter-identity/13-RESEARCH.md
@.planning/phases/13-fighter-identity/13-01-SUMMARY.md
@.planning/phases/13-fighter-identity/13-02-SUMMARY.md

@web/src/app/profile/[wallet]/page.tsx
@web/src/components/profile/EloTierBadge.tsx
@web/src/components/profile/RecentFormIndicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new state and fetch fighter stats</name>
  <files>web/src/app/profile/[wallet]/page.tsx</files>
  <action>
Extend the profile page to fetch and display new fighter stats.

1. Add new state variables after existing state declarations (~line 197-200):
```typescript
const [recentForm, setRecentForm] = useState<Array<{ result: 'win' | 'loss' | 'tie'; pnlPercent: number; endedAt: number }>>([]);
const [battleStreaks, setBattleStreaks] = useState<{ currentStreak: number; bestStreak: number } | null>(null);
const [roi, setRoi] = useState<{ roi: number; totalWagered: number; totalPayout: number } | null>(null);
const [tradingStyle, setTradingStyle] = useState<{ totalPositions: number; avgLeverage: number; aggressionScore: number; longShortRatio: number } | null>(null);
```

2. Add imports at the top of file:
```typescript
import { EloTierBadge, RecentFormIndicator } from '@/components/profile';
```

3. Extend the parallel fetch in useEffect (around line 218) to include new endpoints:
```typescript
const [profileRes, progressionRes, statsRes, rankRes, historyRes, streakRes, rebatesRes, rebateSummaryRes, battleStatsRes, formRes, styleRes] = await Promise.all([
  fetch(`${BACKEND_URL}/api/profile/${walletAddress}`),
  fetch(`${BACKEND_URL}/api/progression/${walletAddress}`),
  fetch(`${BACKEND_URL}/api/stats/${walletAddress}`),
  fetch(`${BACKEND_URL}/api/stats/${walletAddress}/rank`),
  fetch(`${BACKEND_URL}/api/predictions/history/${walletAddress}?limit=50`),
  fetch(`${BACKEND_URL}/api/progression/${walletAddress}/streak`),
  fetch(`${BACKEND_URL}/api/progression/${walletAddress}/rebates`),
  fetch(`${BACKEND_URL}/api/progression/${walletAddress}/rebates/summary`),
  fetch(`${BACKEND_URL}/api/battles/stats/${walletAddress}`),
  fetch(`${BACKEND_URL}/api/battles/form/${walletAddress}?limit=5`),  // New
  fetch(`${BACKEND_URL}/api/battles/style/${walletAddress}`),  // New
]);
```

4. Process new responses after existing response processing (~line 296):
```typescript
// Process recent form
if (formRes.ok) {
  const formData = await formRes.json();
  setRecentForm(formData.form || []);
}

// Process trading style
if (styleRes.ok) {
  const styleData = await styleRes.json();
  setTradingStyle(styleData);
}
```

5. Add a separate fetch for battle streaks and ROI since they're derived from battle history:
```typescript
// Fetch battle streaks from battle stats endpoint (already includes this data)
// Note: The battleStatsRes already contains wins/losses, so calculate display values
if (battleStatsRes.ok) {
  const data = await battleStatsRes.json();
  // Battle streaks come from form analysis
  if (formRes.ok) {
    const formData = await formRes.json();
    const form = formData.form || [];
    // Calculate current streak
    let currentStreak = 0;
    for (const battle of form) {
      if (battle.result === 'win') currentStreak++;
      else break;
    }
    setBattleStreaks({ currentStreak, bestStreak: currentStreak }); // Best streak needs backend
  }
}
```

Note: The full ROI and bestStreak will come from the backend endpoints added in Plan 01.
  </action>
  <verify>
  - New state variables added
  - New fetches added to Promise.all
  - TypeScript compiles: `cd web && pnpm typecheck`
  </verify>
  <done>Profile page fetches form, style data from new endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Add EloTierBadge to profile header</name>
  <files>web/src/app/profile/[wallet]/page.tsx</files>
  <action>
Add EloTierBadge next to the LevelBadge in the profile header.

Find the profile header section (around line 358-365) where LevelBadge is rendered:
```tsx
<div className="flex flex-col sm:flex-row items-center sm:items-start gap-2 sm:gap-3 mb-2">
  <h1 className="text-2xl sm:text-3xl font-black uppercase tracking-tight">
    {profile?.username || formatWallet(walletAddress)}
  </h1>
  {progression && (
    <LevelBadge level={progression.currentLevel} size="lg" showTitle title={tierInfo.title} />
  )}
</div>
```

Modify to add EloTierBadge:
```tsx
<div className="flex flex-col sm:flex-row items-center sm:items-start gap-2 sm:gap-3 mb-2">
  <h1 className="text-2xl sm:text-3xl font-black uppercase tracking-tight">
    {profile?.username || formatWallet(walletAddress)}
  </h1>
  <div className="flex items-center gap-2">
    {progression && (
      <LevelBadge level={progression.currentLevel} size="lg" showTitle title={tierInfo.title} />
    )}
    {battleStats && (
      <EloTierBadge
        tier={battleStats.tier as EloTier}
        elo={battleStats.elo}
        size="lg"
        showElo
      />
    )}
  </div>
</div>
```

Also add EloTier type import if not already done.
  </action>
  <verify>
  - EloTierBadge renders next to LevelBadge
  - Shows tier and ELO number
  - TypeScript compiles: `cd web && pnpm typecheck`
  </verify>
  <done>EloTierBadge displayed in profile header with tier and ELO</done>
</task>

<task type="auto">
  <name>Task 3: Add Battle Stats section with new cards</name>
  <files>web/src/app/profile/[wallet]/page.tsx</files>
  <action>
Add a new "Battle Stats" section after the existing Stats Cards grid (around line 550).

Add new section:
```tsx
{/* Battle Stats Section */}
{battleStats && (battleStats.wins > 0 || battleStats.losses > 0) && (
  <div className="mt-6">
    <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
      <svg className="w-5 h-5 text-danger" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
      Battle Stats
    </h2>

    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
      {/* Battle Record */}
      <div className="card border border-danger/20 p-3 sm:p-4">
        <div className="flex items-center gap-2 mb-2">
          <div className="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-danger/20 flex items-center justify-center border border-danger/30">
            <svg className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-danger" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </div>
          <span className="text-[10px] sm:text-xs text-text-tertiary uppercase tracking-wider">Battle Record</span>
        </div>
        <div className="text-xl sm:text-2xl font-black">
          <span className="text-success">{battleStats.wins}</span>
          <span className="text-text-tertiary mx-1">-</span>
          <span className="text-danger">{battleStats.losses}</span>
        </div>
        <div className="text-[10px] sm:text-xs text-text-tertiary mt-1">
          {((battleStats.wins / (battleStats.wins + battleStats.losses)) * 100).toFixed(0)}% win rate
        </div>
      </div>

      {/* Win Streak */}
      <div className="card border border-fire/20 p-3 sm:p-4">
        <div className="flex items-center gap-2 mb-2">
          <div className="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-fire/20 flex items-center justify-center border border-fire/30">
            <svg className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-fire" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
            </svg>
          </div>
          <span className="text-[10px] sm:text-xs text-text-tertiary uppercase tracking-wider">Win Streak</span>
        </div>
        <div className="text-xl sm:text-2xl font-black text-fire">
          {battleStreaks?.currentStreak || 0}
        </div>
        <div className="text-[10px] sm:text-xs text-text-tertiary mt-1">
          Best: {battleStreaks?.bestStreak || 0}
        </div>
      </div>

      {/* ROI - only show if there's battle data */}
      <div className={cn(
        'card border p-3 sm:p-4',
        (roi?.roi || 0) >= 0 ? 'border-success/20' : 'border-danger/20'
      )}>
        <div className="flex items-center gap-2 mb-2">
          <div className={cn(
            'w-7 h-7 sm:w-8 sm:h-8 rounded-lg flex items-center justify-center border',
            (roi?.roi || 0) >= 0 ? 'bg-success/20 border-success/30' : 'bg-danger/20 border-danger/30'
          )}>
            <svg className={cn('w-3.5 h-3.5 sm:w-4 sm:h-4', (roi?.roi || 0) >= 0 ? 'text-success' : 'text-danger')} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
          </div>
          <span className="text-[10px] sm:text-xs text-text-tertiary uppercase tracking-wider">Battle ROI</span>
        </div>
        <div className={cn('text-xl sm:text-2xl font-black', (roi?.roi || 0) >= 0 ? 'text-success' : 'text-danger')}>
          {(roi?.roi || 0) >= 0 ? '+' : ''}{(roi?.roi || 0).toFixed(1)}%
        </div>
        <div className="text-[10px] sm:text-xs text-text-tertiary mt-1">
          from battles
        </div>
      </div>

      {/* Recent Form */}
      <div className="card border border-accent/20 p-3 sm:p-4">
        <div className="flex items-center gap-2 mb-2">
          <div className="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-accent/20 flex items-center justify-center border border-accent/30">
            <svg className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </div>
          <span className="text-[10px] sm:text-xs text-text-tertiary uppercase tracking-wider">Recent Form</span>
        </div>
        <div className="mt-1">
          <RecentFormIndicator form={recentForm} maxItems={5} size="md" />
        </div>
        <div className="text-[10px] sm:text-xs text-text-tertiary mt-2">
          Last 5 battles
        </div>
      </div>
    </div>
  </div>
)}
```

Add any missing type imports. Ensure cn() is imported from @/lib/utils if not already.
  </action>
  <verify>
  - Battle Stats section renders when user has battles
  - Shows Record, Win Streak, ROI, Recent Form
  - Colors match theme (success/danger/fire/accent)
  - TypeScript compiles: `cd web && pnpm typecheck`
  - Page builds: `cd web && pnpm build`
  </verify>
  <done>Battle Stats section displays record, streak, ROI, and recent form</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd web && pnpm typecheck`
2. Page builds: `cd web && pnpm build`
3. Run locally and visit /profile/[wallet] - Battle Stats section visible for users with battles
4. EloTierBadge shows in header next to LevelBadge
5. RecentFormIndicator shows W/L/T indicators
</verification>

<success_criteria>
- Profile page shows EloTierBadge with tier and ELO
- Battle Stats section displays when user has battles
- Win/loss record visible (PROF-01)
- Win streak and best streak visible (PROF-03)
- ROI percentage visible (PROF-04)
- Recent form indicator shows last 5 battles (PROF-07)
- All TypeScript compilation passes
- Page builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/13-fighter-identity/13-03-SUMMARY.md`
</output>
