---
phase: 13-fighter-identity
plan: 04
type: execute
wave: 2
depends_on: ["13-01", "13-02"]
files_modified:
  - web/src/app/profile/[wallet]/compare/[opponent]/page.tsx
  - web/src/components/profile/ProfileComparison.tsx
  - web/src/app/profile/[wallet]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Comparison page shows two fighters side-by-side"
    - "Comparison highlights which fighter has advantage in each stat"
    - "Profile page has 'Compare' button linking to comparison view"
  artifacts:
    - path: "web/src/app/profile/[wallet]/compare/[opponent]/page.tsx"
      provides: "Fighter comparison page"
      min_lines: 100
    - path: "web/src/components/profile/ProfileComparison.tsx"
      provides: "Side-by-side comparison component"
      min_lines: 80
  key_links:
    - from: "web/src/app/profile/[wallet]/compare/[opponent]/page.tsx"
      to: "/api/battles/compare"
      via: "fetch"
      pattern: "fetch.*api/battles/compare"
---

<objective>
Create profile comparison view for PROF-08

Purpose: Allow fighters to be compared side-by-side showing relative strengths
Output: New comparison page at /profile/[wallet]/compare/[opponent] and ProfileComparison component
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-fighter-identity/13-RESEARCH.md
@.planning/phases/13-fighter-identity/13-01-SUMMARY.md
@.planning/phases/13-fighter-identity/13-02-SUMMARY.md

@web/src/app/profile/[wallet]/page.tsx
@web/src/components/profile/EloTierBadge.tsx
@web/src/components/profile/RecentFormIndicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProfileComparison component</name>
  <files>web/src/components/profile/ProfileComparison.tsx</files>
  <action>
Create ProfileComparison component that displays two fighters side-by-side:

```typescript
'use client';

import { cn } from '@/lib/utils';
import { EloTierBadge, EloTier } from './EloTierBadge';
import { RecentFormIndicator } from './RecentFormIndicator';

interface FighterData {
  wallet: string;
  displayName: string;
  elo: number;
  tier: EloTier;
  battleCount: number;
  wins: number;
  losses: number;
  winRate: number;
  currentStreak: number;
  bestStreak: number;
  roi: number;
  recentForm: Array<{ result: 'win' | 'loss' | 'tie'; pnlPercent: number; endedAt: number }>;
}

interface ProfileComparisonProps {
  fighter1: FighterData;
  fighter2: FighterData;
}

// Format wallet address
function formatWallet(address: string): string {
  if (address.length <= 12) return address;
  return `${address.slice(0, 6)}...${address.slice(-4)}`;
}

// Comparison stat row component
function ComparisonStat({
  label,
  value1,
  value2,
  format = 'number',
  higherIsBetter = true,
}: {
  label: string;
  value1: number;
  value2: number;
  format?: 'number' | 'percent' | 'streak';
  higherIsBetter?: boolean;
}) {
  const winner = higherIsBetter
    ? value1 > value2 ? 1 : value1 < value2 ? 2 : 0
    : value1 < value2 ? 1 : value1 > value2 ? 2 : 0;

  const formatValue = (v: number) => {
    if (format === 'percent') return `${v >= 0 ? '+' : ''}${v.toFixed(1)}%`;
    if (format === 'streak') return `${v}`;
    return v.toFixed(0);
  };

  return (
    <div className="grid grid-cols-3 gap-4 py-3 border-b border-border-primary/50">
      <div className={cn(
        'text-right font-bold text-lg',
        winner === 1 ? 'text-success' : 'text-text-primary'
      )}>
        {formatValue(value1)}
        {winner === 1 && <span className="ml-1 text-xs">+</span>}
      </div>
      <div className="text-center text-text-tertiary text-sm uppercase tracking-wider">
        {label}
      </div>
      <div className={cn(
        'text-left font-bold text-lg',
        winner === 2 ? 'text-success' : 'text-text-primary'
      )}>
        {formatValue(value2)}
        {winner === 2 && <span className="ml-1 text-xs">+</span>}
      </div>
    </div>
  );
}

export function ProfileComparison({ fighter1, fighter2 }: ProfileComparisonProps) {
  return (
    <div className="space-y-6">
      {/* Fighter Headers */}
      <div className="grid grid-cols-2 gap-6">
        {/* Fighter 1 */}
        <div className="card border border-accent/30 p-4 text-center">
          <div className="w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-br from-accent/30 to-accent/10 flex items-center justify-center border-4 border-accent/30">
            <svg className="w-8 h-8 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
          <h3 className="text-xl font-bold mb-2">{fighter1.displayName || formatWallet(fighter1.wallet)}</h3>
          <EloTierBadge tier={fighter1.tier} elo={fighter1.elo} showElo />
        </div>

        {/* VS Divider */}
        <div className="absolute left-1/2 -translate-x-1/2 top-24 z-10">
          <div className="w-12 h-12 rounded-full bg-danger flex items-center justify-center shadow-lg shadow-danger/50">
            <span className="text-white font-black text-sm">VS</span>
          </div>
        </div>

        {/* Fighter 2 */}
        <div className="card border border-fire/30 p-4 text-center">
          <div className="w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-br from-fire/30 to-fire/10 flex items-center justify-center border-4 border-fire/30">
            <svg className="w-8 h-8 text-fire" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
          <h3 className="text-xl font-bold mb-2">{fighter2.displayName || formatWallet(fighter2.wallet)}</h3>
          <EloTierBadge tier={fighter2.tier} elo={fighter2.elo} showElo />
        </div>
      </div>

      {/* Stats Comparison */}
      <div className="card border border-border-primary p-4">
        <h4 className="text-center text-text-tertiary uppercase tracking-wider text-sm mb-4">
          Head to Head Stats
        </h4>

        <ComparisonStat
          label="ELO Rating"
          value1={fighter1.elo}
          value2={fighter2.elo}
        />
        <ComparisonStat
          label="Win Rate"
          value1={fighter1.winRate}
          value2={fighter2.winRate}
          format="percent"
        />
        <ComparisonStat
          label="Battles"
          value1={fighter1.battleCount}
          value2={fighter2.battleCount}
        />
        <ComparisonStat
          label="Wins"
          value1={fighter1.wins}
          value2={fighter2.wins}
        />
        <ComparisonStat
          label="Current Streak"
          value1={fighter1.currentStreak}
          value2={fighter2.currentStreak}
          format="streak"
        />
        <ComparisonStat
          label="Best Streak"
          value1={fighter1.bestStreak}
          value2={fighter2.bestStreak}
          format="streak"
        />
        <ComparisonStat
          label="ROI"
          value1={fighter1.roi}
          value2={fighter2.roi}
          format="percent"
        />
      </div>

      {/* Recent Form Comparison */}
      <div className="grid grid-cols-2 gap-6">
        <div className="card border border-accent/20 p-4">
          <h4 className="text-center text-text-tertiary uppercase tracking-wider text-xs mb-3">Recent Form</h4>
          <div className="flex justify-center">
            <RecentFormIndicator form={fighter1.recentForm} maxItems={5} />
          </div>
        </div>
        <div className="card border border-fire/20 p-4">
          <h4 className="text-center text-text-tertiary uppercase tracking-wider text-xs mb-3">Recent Form</h4>
          <div className="flex justify-center">
            <RecentFormIndicator form={fighter2.recentForm} maxItems={5} />
          </div>
        </div>
      </div>
    </div>
  );
}
```

Export from barrel file - update web/src/components/profile/index.ts:
```typescript
export { ProfileComparison } from './ProfileComparison';
```
  </action>
  <verify>
  - File exists at web/src/components/profile/ProfileComparison.tsx
  - Exported from index.ts
  - TypeScript compiles: `cd web && pnpm typecheck`
  </verify>
  <done>ProfileComparison component shows side-by-side fighter stats with advantage highlighting</done>
</task>

<task type="auto">
  <name>Task 2: Create comparison page</name>
  <files>web/src/app/profile/[wallet]/compare/[opponent]/page.tsx</files>
  <action>
Create the comparison page:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import Link from 'next/link';
import { PageLoading } from '@/components/ui/skeleton';
import { ProfileComparison, EloTier } from '@/components/profile';
import { BACKEND_URL } from '@/config/api';

interface FighterData {
  wallet: string;
  displayName: string;
  elo: number;
  tier: EloTier;
  battleCount: number;
  wins: number;
  losses: number;
  winRate: number;
  currentStreak: number;
  bestStreak: number;
  roi: number;
  recentForm: Array<{ result: 'win' | 'loss' | 'tie'; pnlPercent: number; endedAt: number }>;
}

interface ComparisonData {
  fighter1: FighterData;
  fighter2: FighterData;
}

function formatWallet(address: string): string {
  if (address.length <= 12) return address;
  return `${address.slice(0, 6)}...${address.slice(-4)}`;
}

export default function ComparisonPage() {
  const params = useParams();
  const wallet1 = params.wallet as string;
  const wallet2 = params.opponent as string;

  const [comparison, setComparison] = useState<ComparisonData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!wallet1 || !wallet2) return;

    const fetchComparison = async () => {
      setLoading(true);
      setError(null);

      try {
        // Fetch comparison data from backend
        const [compareRes, profile1Res, profile2Res, form1Res, form2Res] = await Promise.all([
          fetch(`${BACKEND_URL}/api/battles/compare/${wallet1}/${wallet2}`),
          fetch(`${BACKEND_URL}/api/profile/${wallet1}`),
          fetch(`${BACKEND_URL}/api/profile/${wallet2}`),
          fetch(`${BACKEND_URL}/api/battles/form/${wallet1}?limit=5`),
          fetch(`${BACKEND_URL}/api/battles/form/${wallet2}?limit=5`),
        ]);

        if (!compareRes.ok) {
          throw new Error('Failed to fetch comparison data');
        }

        const compareData = await compareRes.json();
        const profile1 = profile1Res.ok ? await profile1Res.json() : null;
        const profile2 = profile2Res.ok ? await profile2Res.json() : null;
        const form1Data = form1Res.ok ? await form1Res.json() : { form: [] };
        const form2Data = form2Res.ok ? await form2Res.json() : { form: [] };

        setComparison({
          fighter1: {
            ...compareData.fighter1,
            displayName: profile1?.username || formatWallet(wallet1),
            recentForm: form1Data.form || [],
          },
          fighter2: {
            ...compareData.fighter2,
            displayName: profile2?.username || formatWallet(wallet2),
            recentForm: form2Data.form || [],
          },
        });
      } catch (err) {
        console.error('Failed to fetch comparison:', err);
        setError('Failed to load comparison data');
      } finally {
        setLoading(false);
      }
    };

    fetchComparison();
  }, [wallet1, wallet2]);

  if (loading) {
    return <PageLoading message="Loading comparison..." />;
  }

  if (error || !comparison) {
    return (
      <div className="max-w-4xl mx-auto px-4 sm:px-6 py-12 text-center">
        <div className="card border border-danger/30 p-8">
          <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-danger/20 flex items-center justify-center">
            <svg className="w-8 h-8 text-danger" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h2 className="text-xl font-bold mb-2">Error Loading Comparison</h2>
          <p className="text-text-secondary mb-4">{error || 'Unable to load data'}</p>
          <Link href={`/profile/${wallet1}`} className="btn btn-primary">
            Back to Profile
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto px-4 sm:px-6 py-8 animate-fadeIn">
      {/* Header */}
      <div className="mb-6">
        <Link
          href={`/profile/${wallet1}`}
          className="text-accent hover:text-accent/80 transition-colors flex items-center gap-1 text-sm mb-4"
        >
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Profile
        </Link>
        <h1 className="text-2xl sm:text-3xl font-black uppercase tracking-tight">
          Fighter Comparison
        </h1>
        <p className="text-text-secondary mt-1">
          Head-to-head stat comparison
        </p>
      </div>

      {/* Comparison Component */}
      <div className="relative">
        <ProfileComparison
          fighter1={comparison.fighter1}
          fighter2={comparison.fighter2}
        />
      </div>

      {/* Challenge Button */}
      <div className="mt-8 text-center">
        <Link
          href={`/battle?challenge=${wallet2}`}
          className="btn btn-primary btn-lg"
        >
          <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          Challenge to Battle
        </Link>
      </div>
    </div>
  );
}
```

Create necessary directories:
- web/src/app/profile/[wallet]/compare/
- web/src/app/profile/[wallet]/compare/[opponent]/
  </action>
  <verify>
  - File exists at web/src/app/profile/[wallet]/compare/[opponent]/page.tsx
  - TypeScript compiles: `cd web && pnpm typecheck`
  - Route accessible at /profile/[wallet]/compare/[opponent]
  </verify>
  <done>Comparison page fetches and displays two fighters side-by-side</done>
</task>

<task type="auto">
  <name>Task 3: Add Compare button to profile page</name>
  <files>web/src/app/profile/[wallet]/page.tsx</files>
  <action>
Add a "Compare" button to the profile page header for non-own profiles.

Find the Quick Stats Row section (around line 401-450) where the ProfileShareButton is rendered.

Add a Compare button for non-own profiles, after the ProfileShareButton:

```tsx
{/* Quick Stats Row */}
<div className="flex flex-wrap items-center justify-center sm:justify-start gap-3 sm:gap-4">
  {/* ... existing rank and streak badges ... */}

  {battleStats && (
    <ProfileShareButton
      wallet={walletAddress}
      displayName={profile?.username || formatWallet(walletAddress)}
      wins={battleStats.wins}
      losses={battleStats.losses}
      elo={battleStats.elo}
      tier={battleStats.tier}
      referralCode={isOwnProfile ? referralCode : undefined}
    />
  )}

  {/* Compare button - only show on other users' profiles when logged in */}
  {!isOwnProfile && connected && publicKey && (
    <Link
      href={`/profile/${walletAddress}/compare/${publicKey.toBase58()}`}
      className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-fire/30 bg-fire/10 text-fire hover:bg-fire/20 transition-colors text-sm"
    >
      <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      Compare
    </Link>
  )}
</div>
```

This button will:
- Only appear when viewing another user's profile (not own profile)
- Only appear when user is logged in with wallet
- Link to comparison page with current user as the second fighter
  </action>
  <verify>
  - Compare button appears on other users' profiles when logged in
  - Button links to /profile/[their-wallet]/compare/[my-wallet]
  - TypeScript compiles: `cd web && pnpm typecheck`
  - Page builds: `cd web && pnpm build`
  </verify>
  <done>Compare button added to profile page for non-own profiles</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd web && pnpm typecheck`
2. Page builds: `cd web && pnpm build`
3. ProfileComparison component exists and shows side-by-side comparison
4. Comparison page loads at /profile/[wallet]/compare/[opponent]
5. Compare button appears on other users' profiles
6. Clicking Compare navigates to comparison page
</verification>

<success_criteria>
- ProfileComparison component displays two fighters with highlighted advantages
- Comparison page fetches data from /api/battles/compare endpoint
- Compare button on profile page links to comparison view
- All stats compared: ELO, win rate, battles, wins, streaks, ROI
- Recent form shown for both fighters
- Challenge button links to battle with opponent
- TypeScript compilation passes
- Page builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/13-fighter-identity/13-04-SUMMARY.md`
</output>
