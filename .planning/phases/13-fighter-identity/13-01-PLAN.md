---
phase: 13-fighter-identity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/fighterStatsService.ts
  - backend/src/db/battleHistoryDatabase.ts
  - backend/src/index.ts
autonomous: true

must_haves:
  truths:
    - "API returns trading style stats for a wallet"
    - "API returns favorite assets for a wallet"
    - "API returns recent form (last 5 battles) for a wallet"
    - "API returns comparison data for two wallets"
  artifacts:
    - path: "backend/src/services/fighterStatsService.ts"
      provides: "Fighter stats calculation service"
      exports: ["getTradingStyle", "getFavoriteAssets", "getRecentForm", "getComparison"]
  key_links:
    - from: "backend/src/index.ts"
      to: "fighterStatsService"
      via: "API endpoint handlers"
      pattern: "/api/battles/(style|favorites|form|compare)"
---

<objective>
Create backend service and API endpoints for fighter statistics

Purpose: Provide data layer for PROF-05 (trading style), PROF-06 (favorites), PROF-07 (recent form), and PROF-08 (comparison)
Output: New fighterStatsService with 4 API endpoints for frontend consumption
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-fighter-identity/13-RESEARCH.md

@backend/src/db/battleHistoryDatabase.ts
@backend/src/db/eloDatabase.ts
@backend/src/services/eloService.ts
@backend/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fighterStatsService</name>
  <files>backend/src/services/fighterStatsService.ts</files>
  <action>
Create new service with the following functions:

1. `getTradingStyle(wallet: string)` - Returns:
   - `totalPositions`: number of positions opened (from battle history count * estimated 2-3 per battle)
   - `avgLeverage`: Average leverage used (default to median 10x until trade-level data available)
   - `aggressionScore`: Calculate from win rate + battle frequency (battles per week)
   - `longShortRatio`: Default 50/50 until trade-level data available
   - Note: Add TODO comment for future enhancement when trade-level persistence is added

2. `getFavoriteAssets(wallet: string, minBattles: number = 3)` - Returns:
   - Array of top 3 assets by battle count
   - For now, return ["SOL", "ETH", "BTC"] as defaults since asset-per-battle isn't tracked
   - Add TODO for future enhancement when position data is persisted

3. `getRecentForm(wallet: string, limit: number = 5)` - Returns:
   - Array of last N battle results: `{ result: 'win' | 'loss' | 'tie', pnlPercent: number, endedAt: number }`
   - Use existing `getBattleHistory` from battleHistoryDatabase

4. `getComparison(wallet1: string, wallet2: string)` - Returns single response with both fighters' data:
   - For each fighter: { wallet, elo, tier, battleCount, wins, losses, winRate, winStreak, bestStreak, roi }
   - winStreak: Calculate from consecutive wins in battle history
   - bestStreak: Max win streak ever achieved
   - roi: Calculate as (totalPayout - totalEntryFees) / totalEntryFees * 100

Use existing patterns from eloDatabase and battleHistoryDatabase. Import getDisplayTier from eloService.
  </action>
  <verify>
  - File exists at backend/src/services/fighterStatsService.ts
  - Exports all 4 functions
  - TypeScript compiles: `cd backend && npx tsc --noEmit`
  </verify>
  <done>fighterStatsService exports getTradingStyle, getFavoriteAssets, getRecentForm, getComparison with proper types</done>
</task>

<task type="auto">
  <name>Task 2: Extend battleHistoryDatabase for streaks</name>
  <files>backend/src/db/battleHistoryDatabase.ts</files>
  <action>
Add two new query functions to battleHistoryDatabase:

1. `getBattleStreaks(walletAddress: string)` - Returns `{ currentStreak: number, bestStreak: number }`:
   - Query battle_history ordered by ended_at DESC
   - Calculate current win streak (consecutive wins from most recent)
   - Calculate best ever win streak
   - Pattern: Iterate through results, increment streak on win, reset on loss/tie

2. `getBattleROI(walletAddress: string)` - Returns `{ roi: number, totalWagered: number, totalPayout: number }`:
   - Sum all entry_fee as totalWagered
   - Sum payouts: wins get prize_pool * 0.95, ties get entry_fee back, losses get 0
   - Calculate ROI = (totalPayout - totalWagered) / totalWagered * 100
   - Handle edge case: if totalWagered is 0, return roi: 0

Follow existing pattern from getPlayerStats. Use BattleHistoryRow type.
  </action>
  <verify>
  - Functions exist and export from battleHistoryDatabase
  - `cd backend && npx tsc --noEmit` passes
  </verify>
  <done>getBattleStreaks and getBattleROI functions added and exported</done>
</task>

<task type="auto">
  <name>Task 3: Add API endpoints</name>
  <files>backend/src/index.ts</files>
  <action>
Add 4 new API endpoints in index.ts (place near existing /api/battles/ routes, before the /api/battles/:id catch-all):

```typescript
import * as fighterStatsService from './services/fighterStatsService';

// GET /api/battles/style/:wallet - Trading style stats (PROF-05)
app.get('/api/battles/style/:wallet', (req, res) => {
  try {
    const style = fighterStatsService.getTradingStyle(req.params.wallet);
    res.json(style);
  } catch (error) {
    console.error('[API] Error fetching trading style:', error);
    res.status(500).json({ error: 'Failed to fetch trading style' });
  }
});

// GET /api/battles/favorites/:wallet - Favorite assets (PROF-06)
app.get('/api/battles/favorites/:wallet', (req, res) => {
  try {
    const favorites = fighterStatsService.getFavoriteAssets(req.params.wallet);
    res.json({ assets: favorites });
  } catch (error) {
    console.error('[API] Error fetching favorite assets:', error);
    res.status(500).json({ error: 'Failed to fetch favorite assets' });
  }
});

// GET /api/battles/form/:wallet - Recent form (PROF-07)
app.get('/api/battles/form/:wallet', (req, res) => {
  try {
    const limit = parseInt(req.query.limit as string) || 5;
    const form = fighterStatsService.getRecentForm(req.params.wallet, limit);
    res.json({ form });
  } catch (error) {
    console.error('[API] Error fetching recent form:', error);
    res.status(500).json({ error: 'Failed to fetch recent form' });
  }
});

// GET /api/battles/compare/:wallet1/:wallet2 - Comparison data (PROF-08)
app.get('/api/battles/compare/:wallet1/:wallet2', (req, res) => {
  try {
    const comparison = fighterStatsService.getComparison(
      req.params.wallet1,
      req.params.wallet2
    );
    res.json(comparison);
  } catch (error) {
    console.error('[API] Error fetching comparison:', error);
    res.status(500).json({ error: 'Failed to fetch comparison' });
  }
});
```

Place these routes BEFORE the `/api/battles/:id` route to ensure proper matching.
  </action>
  <verify>
  - Start backend: `cd backend && npm run dev` (should start without errors)
  - Test endpoints with curl:
    - `curl http://localhost:3001/api/battles/style/testWallet123`
    - `curl http://localhost:3001/api/battles/form/testWallet123`
    - `curl http://localhost:3001/api/battles/compare/wallet1/wallet2`
  - All should return JSON (even if empty data for non-existent wallets)
  </verify>
  <done>4 new API endpoints respond with JSON data</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd backend && npx tsc --noEmit`
2. Backend starts successfully: `npm run dev`
3. All 4 endpoints return JSON responses
4. fighterStatsService.ts exists with 4 exported functions
</verification>

<success_criteria>
- fighterStatsService created with getTradingStyle, getFavoriteAssets, getRecentForm, getComparison
- battleHistoryDatabase extended with getBattleStreaks, getBattleROI
- 4 API endpoints added and responding
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/13-fighter-identity/13-01-SUMMARY.md`
</output>
