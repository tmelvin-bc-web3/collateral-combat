# Build

You are an autonomous coding agent. Your task is to complete the work for exactly one story and record the outcome.

## Paths
- PRD: /Users/taylermelvin/Desktop/sol-battles/.agents/tasks/prd.md
- Implementation Plan: /Users/taylermelvin/Desktop/sol-battles/.ralph/IMPLEMENTATION_PLAN.md
- AGENTS (optional): /Users/taylermelvin/Desktop/sol-battles/AGENTS.md
- Progress Log: /Users/taylermelvin/Desktop/sol-battles/.ralph/progress.md
- Guardrails: /Users/taylermelvin/Desktop/sol-battles/.ralph/guardrails.md
- Guardrails Reference: /Users/taylermelvin/Desktop/sol-battles/.agents/ralph/references/GUARDRAILS.md
- Context Reference: /Users/taylermelvin/Desktop/sol-battles/.agents/ralph/references/CONTEXT_ENGINEERING.md
- Errors Log: /Users/taylermelvin/Desktop/sol-battles/.ralph/errors.log
- Activity Log: /Users/taylermelvin/Desktop/sol-battles/.ralph/activity.log
- Activity Logger: /Users/taylermelvin/Desktop/sol-battles/ralph log
- No-commit: false
- Repo Root: /Users/taylermelvin/Desktop/sol-battles
- Run ID: 20260112-220545-89702
- Iteration: 1
- Run Log: /Users/taylermelvin/Desktop/sol-battles/.ralph/runs/run-20260112-220545-89702-iter-1.log
- Run Summary: /Users/taylermelvin/Desktop/sol-battles/.ralph/runs/run-20260112-220545-89702-iter-1.md

## Selected Story (Do not change scope)
ID: US-002
Title: Smart Contract Alignment

Story details:
### [ ] US-002: Smart Contract Alignment
Fix timing, add early bird multiplier, and add locked status to smart contract.

**Requires:** Solana MCP

**Tasks:**
- T210: Change LOCK_PERIOD from 10s to 5s
- T211: Add bet_timestamp to PlayerPosition, calculate early bird multiplier in claim_winnings
- T212: Change RoundStatus from {Open, Settled} to {Betting, Locked, Settled}

**Files:** prediction_program/programs/prediction_program/src/lib.rs, state.rs

**Verify:** On-chain timing matches backend, early bets get bonus payout

---


If the story details are empty or missing, STOP and report that the PRD story format could not be parsed.

## Rules (Non-Negotiable)
- Implement **only** the work required to complete the selected story.
- Complete all tasks associated with this story (and only this story).
- Do NOT ask the user questions.
- Do NOT change unrelated code.
- If the plan is missing, stop and recommend running plan mode.
- Do NOT assume something is unimplemented — confirm by reading code.
- Implement completely; no placeholders or stubs.
- If No-commit is true, do NOT commit or push changes.
- All changes made during the run must be committed (including updates to PRD/plan/progress/logs).

## Your Task (Do this in order)
1. Read /Users/taylermelvin/Desktop/sol-battles/.ralph/guardrails.md before any code changes.
2. Read /Users/taylermelvin/Desktop/sol-battles/.ralph/errors.log for repeated failures to avoid.
3. Read /Users/taylermelvin/Desktop/sol-battles/.agents/tasks/prd.md.
4. Read /Users/taylermelvin/Desktop/sol-battles/.ralph/IMPLEMENTATION_PLAN.md and locate the section for US-002.
   - If no section exists, create `### US-002: Smart Contract Alignment` and add the tasks needed.
5. Fully audit and read all necessary files to understand the task end-to-end before implementing. Do not assume missing functionality.
6. If /Users/taylermelvin/Desktop/sol-battles/AGENTS.md exists, follow its build/test instructions.
7. Implement only the tasks that belong to US-002.
8. Run the verification commands listed in the story’s tasks (or in AGENTS.md if required).
9. Update /Users/taylermelvin/Desktop/sol-battles/.ralph/IMPLEMENTATION_PLAN.md:
   - Mark story tasks `[x]` when done.
   - Add notes or new tasks only within the US-002 section.
10. Update the PRD:
   - Check off **all acceptance criteria** for US-002 (`- [x]`) once verified.
   - Only after all acceptance criteria are checked, mark the story heading as complete
     (change `### [ ] US-002:` to `### [x] US-002:`).
11. If No-commit is false, commit changes using the `$commit` skill.
    - Stage everything: `git add -A`
    - Confirm a clean working tree after commit: `git status --porcelain` should be empty.
    - After committing, capture the commit hash and subject using:
      `git show -s --format="%h %s" HEAD`.
12. Append a progress entry to /Users/taylermelvin/Desktop/sol-battles/.ralph/progress.md with run/commit/test details (format below).
    If No-commit is true, skip committing and note it in the progress entry.

## Progress Entry Format (Append Only)
```
## [Date/Time] - US-002: Smart Contract Alignment
Thread: [codex exec session id if available, otherwise leave blank]
Run: 20260112-220545-89702 (iteration 1)
Run log: /Users/taylermelvin/Desktop/sol-battles/.ralph/runs/run-20260112-220545-89702-iter-1.log
Run summary: /Users/taylermelvin/Desktop/sol-battles/.ralph/runs/run-20260112-220545-89702-iter-1.md
- Guardrails reviewed: yes
- No-commit run: false
- Commit: <hash> <subject> (or `none` + reason)
- Post-commit status: `clean` or list remaining files
- Verification:
  - Command: <exact command> -> PASS/FAIL
  - Command: <exact command> -> PASS/FAIL
- Files changed:
  - <file path>
  - <file path>
- What was implemented
- **Learnings for future iterations:**
  - Patterns discovered
  - Gotchas encountered
  - Useful context
---
```

## Completion Signal
Only output the completion signal when **all stories** in the PRD are complete (i.e., every story is checked in /Users/taylermelvin/Desktop/sol-battles/.agents/tasks/prd.md). Completing the selected story is not sufficient unless it was the last remaining story.
If there are no remaining unchecked stories in /Users/taylermelvin/Desktop/sol-battles/.agents/tasks/prd.md, output:
<promise>COMPLETE</promise>

Otherwise, end normally.

## Additional Guardrails
- When authoring documentation, capture the why (tests + implementation intent).
- Keep /Users/taylermelvin/Desktop/sol-battles/.ralph/IMPLEMENTATION_PLAN.md current with discoveries; it is the source of truth for the loop.
- If you learn how to run/build/test the project, update /Users/taylermelvin/Desktop/sol-battles/AGENTS.md briefly (operational only).
- Keep AGENTS operational only; progress notes belong in /Users/taylermelvin/Desktop/sol-battles/.ralph/IMPLEMENTATION_PLAN.md or /Users/taylermelvin/Desktop/sol-battles/.ralph/progress.md.
- If you hit repeated errors, log them in /Users/taylermelvin/Desktop/sol-battles/.ralph/errors.log and add a Sign to /Users/taylermelvin/Desktop/sol-battles/.ralph/guardrails.md using /Users/taylermelvin/Desktop/sol-battles/.agents/ralph/references/GUARDRAILS.md as the template.

## Activity Logging (Required)
Log major actions to /Users/taylermelvin/Desktop/sol-battles/.ralph/activity.log using the helper:
```
/Users/taylermelvin/Desktop/sol-battles/ralph log "message"
```
Log at least:
- Start of work on the story
- After major code changes
- After tests/verification
- After updating plan and PRD

## Browser Testing (Required for Frontend Stories)
If the selected story changes UI, you MUST verify it in the browser:
1. Load the `dev-browser` skill.
2. Navigate to the relevant page.
3. Verify the UI changes work as expected.
4. Take a screenshot if helpful for the progress log.

A frontend story is NOT complete until browser verification passes.
